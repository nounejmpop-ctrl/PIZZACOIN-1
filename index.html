
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ì–Ω–µ–≤ –ü–∏—Ü—Ü–∞–π–æ–ª–æ: Dino Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  :root {
    --primary-color: #ffca28; --secondary-color: #ff6f00; --dark-bg: rgba(0,0,0,0.95);
    --item-bg: #222; --accent-shadow: #ffca28; --hp-color: #4CAF50;
    --tp-color: #4a90e2; --enemy-hp-color: #f44336; --rage-color: #e74c3c;
  }
  @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
  
  body { 
      margin: 0; padding: 0; 
      background: url('https://i.imgur.com/4Nk4Ewd.jpg') no-repeat center center fixed; 
      background-size: cover; 
      font-family: 'Fredoka One', cursive, Arial, sans-serif; 
      color: #fff; text-align: center; 
      user-select: none; -webkit-user-select: none;
      transition: filter 0.5s; padding-bottom: 150px; 
      touch-action: manipulation;
      overscroll-behavior: none;
  }
  .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--dark-bg); z-index: -1; }
  
  /* --- MAIN UI --- */
  h1 { margin-top: 20px; font-size: 2.5em; text-shadow: 2px 2px 6px #000; }
  #coins { color: var(--primary-color); transition: transform 0.2s; display: inline-block; }
  .coin-pulse { transform: scale(1.5); }
  
  #addCoinBtn { 
    position: relative; z-index: 100;
    margin: 10px auto; padding: 20px 60px; font-size: 24px; 
    background: linear-gradient(45deg, var(--secondary-color), var(--primary-color)); 
    border: none; border-radius: 15px; box-shadow: 0 8px #cc5500; 
    cursor: pointer; color: #000; font-weight: bold;
    touch-action: none; /* CRITICAL: Disables browser gestures on button for multi-touch */
    transition: transform 0.05s, box-shadow 0.05s;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }
  #addCoinBtn:active { transform: translateY(4px); box-shadow: 0 2px #cc5500; }

  /* --- NPC & HEADER --- */
  .npc-avatar {
    width: 80px; height: 80px; border-radius: 50%; border: 3px solid #fff;
    background: #555; display: inline-flex; align-items: center; justify-content: center;
    font-size: 40px; cursor: pointer; box-shadow: 0 0 15px var(--primary-color);
    transition: transform 0.2s; position: relative; z-index: 50;
  }
  .npc-avatar:hover { transform: scale(1.1); }
  .npc-quest-mark {
      position: absolute; top: 0; right: 0; width: 20px; height: 20px; background: red;
      border-radius: 50%; border: 2px solid white; animation: pulse 1s infinite; display: none;
  }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
  
  .top-bar { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 10px; position: relative; z-index: 50; }

  /* --- CAT HOUSE --- */
  #catHouse {
      display: none; background: rgba(255, 255, 255, 0.1); border-radius: 15px;
      padding: 15px; margin: 20px auto; max-width: 600px; border: 2px dashed #ffca28;
  }
  .cat-main { font-size: 4em; cursor: pointer; transition: 0.2s; display: inline-block; }
  .cat-main:active { transform: scale(0.9) rotate(-10deg); }
  .kittens-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 10px; }
  .kitten-card { 
      background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 10px; 
      font-size: 0.9em; display: flex; flex-direction: column; align-items: center;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid #555;
  }
  @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

  /* --- SHOP & PANELS --- */
  .panel { max-width: 700px; margin: 0 auto 20px; background: rgba(0,0,0,0.8); border-radius: 15px; padding: 15px; border: 1px solid #444; }
  
  .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
  .item-card { 
    background: var(--item-bg); border-radius: 8px; padding: 10px; 
    border: 1px solid #444; display: flex; flex-direction: column; justify-content: space-between;
  }
  .item-card h4 { margin: 5px 0; color: var(--primary-color); }
  .item-card button { 
    background: var(--primary-color); border: none; padding: 8px; 
    border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px;
  }
  .item-card button:disabled { background: #555; cursor: not-allowed; }

  /* --- BATTLE UI --- */
  #battleModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 2000; flex-direction: column; }
  #battleContainer { width: 100%; height: 100%; max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
  
  .battle-header { display: flex; justify-content: space-between; padding: 10px; background: #222; border-radius: 10px; margin-bottom: 10px; }
  .battle-field { flex-grow: 1; position: relative; display: flex; justify-content: space-between; align-items: center; padding: 20px; background: url('https://img.freepik.com/free-vector/restaurant-mural-wallpaper_23-2148706001.jpg') center/cover; border-radius: 10px; border: 2px solid #555; overflow: hidden; }
  .battle-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 0; }
  
  /* PARTY & ENEMY */
  .party-slots { display: flex; flex-direction: column; gap: 15px; z-index: 1; width: 35%; }
  .enemy-slots { z-index: 1; width: 55%; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
  
  .char-card { 
    background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; border-left: 5px solid #555; 
    transition: 0.3s; position: relative; color: white; text-align: left;
  }
  .char-card.active { border-left-color: var(--primary-color); transform: translateX(20px); background: rgba(255, 202, 40, 0.2); }
  .char-card.dead { opacity: 0.5; filter: grayscale(1); }
  .char-card.rage { border-left-color: var(--rage-color); box-shadow: 0 0 20px var(--rage-color); animation: rage-pulse 1s infinite; }
  .char-card.mounted { border-left-color: #2ecc71; box-shadow: 0 0 15px #2ecc71; border: 2px solid #2ecc71; }
  
  .enemy-card {
    background: rgba(50,0,0,0.8); padding: 10px; border-radius: 8px; border: 2px solid transparent;
    display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; min-width: 100px;
  }
  .enemy-card.selected-target { border-color: red; box-shadow: 0 0 15px red; transform: scale(1.05); }
  .enemy-card.rage { border-color: var(--rage-color); box-shadow: 0 0 20px var(--rage-color); animation: rage-pulse 0.5s infinite; }
  .enemy-card.dead { display: none; }
  .enemy-card.hostage { border-color: #3498db; animation: shake-hostage 2s infinite; }
  .enemy-card.golden { border-color: gold; box-shadow: 0 0 20px gold; }
  @keyframes shake-hostage { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }

  .hp-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-top: 5px; }
  .hp-fill { height: 100%; background: var(--hp-color); width: 100%; transition: width 0.3s; }
  
  .enemy-sprite { font-size: 4em; filter: drop-shadow(0 0 5px black); }
  
  /* CONTROLS */
  .battle-controls { height: 200px; background: #222; margin-top: 10px; border-radius: 10px; padding: 10px; display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }
  .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .action-btn { border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; font-family: 'Fredoka One'; color: white; text-shadow: 1px 1px 0 #000; touch-action: manipulation; }
  .btn-atk { background: #e74c3c; } .btn-skl { background: #9b59b6; }
  .btn-def { background: #f39c12; } .btn-itm { background: #3498db; }
  .btn-mount { background: #27ae60; border: 2px solid #fff; grid-column: 1 / -1; }
  .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  
  #battleLog { background: #111; padding: 10px; overflow-y: auto; font-size: 0.9em; text-align: left; color: #ccc; border-radius: 5px; font-family: monospace; }
  
  /* PIZZA NINJA GAME */
  #ninjaModal { display: none; position: fixed; inset: 0; background: #000; z-index: 4000; overflow: hidden; }
  #ninjaCanvas { width: 100%; height: 100%; touch-action: none; }
  .ninja-ui { position: absolute; top: 10px; left: 10px; font-size: 2em; text-shadow: 2px 2px 0 #000; pointer-events: none; }
  .ninja-object { position: absolute; font-size: 4em; user-select: none; pointer-events: none; }
  .slice-trail { position: absolute; height: 5px; background: white; border-radius: 5px; pointer-events: none; transform-origin: left center; box-shadow: 0 0 10px #fff; }

  /* PARTY SELECT */
  #partySelectModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; justify-content: center; align-items: center; }
  .select-container { background: #222; padding: 20px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; text-align: center; }
  .select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin: 20px 0; }
  .select-item { background: #333; padding: 10px; border-radius: 5px; cursor: pointer; border: 2px solid transparent; }
  .select-item.selected { border-color: var(--primary-color); background: #444; }

  /* EFFECTS */
  @keyframes rage-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
  .damage-popup { position: absolute; font-size: 2em; font-weight: bold; color: white; text-shadow: 2px 2px 0 #000; animation: floatUp 1s forwards; pointer-events: none; z-index: 9999; }
  @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
  .swoon-effect { animation: shake 0.5s; border: 5px solid red !important; }
  @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
  
  .nav-btn { background: #444; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 5px; cursor: pointer; touch-action: manipulation; }
  .tutorial-highlight { border: 2px solid #f1c40f; box-shadow: 0 0 15px #f1c40f; }

  /* ACH & MODALS */
  .modal { display: none; position: fixed; z-index: 5000; inset: 0; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
  .modal-box { background: #222; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; text-align: left; max-height: 80vh; overflow-y: auto; }
  .ach-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #2ecc71; padding: 10px 20px; border-radius: 20px; z-index: 6000; animation: slideDown 0.5s forwards; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
  @keyframes slideDown { from {top: -50px;} to {top: 20px;} }
  
  .input-code { padding: 10px; border-radius: 5px; border: none; width: 60%; }
  .ach-item { padding: 10px; background: #333; margin-bottom: 5px; border-radius: 5px; opacity: 0.5; }
  .ach-item.unlocked { opacity: 1; border-left: 4px solid var(--primary-color); }

  .speech-bubble {
    position: relative; background: #fff; color: #000; border-radius: .4em; padding: 10px; 
    margin-bottom: 10px; font-size: 0.9em;
  }
  .speech-bubble:after {
    content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 0;
    border: 10px solid transparent; border-top-color: #fff; border-bottom: 0;
    margin-left: -10px; margin-bottom: -10px;
  }

  .quest-item { background: #444; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
  .quest-item.completed { opacity: 0.6; border: 1px solid #0f0; }
  .quest-reward { color: yellow; font-size: 0.8em; }
  
  /* PATHS MODAL */
  .path-option { 
    border: 2px solid #555; padding: 15px; margin: 10px 0; border-radius: 10px; cursor: pointer; transition: 0.2s;
    display: flex; align-items: center; gap: 15px;
  }
  .path-option:hover { background: #333; border-color: #fff; }
  .path-option.selected { border-color: var(--primary-color); background: rgba(255, 202, 40, 0.1); }
  .path-icon { font-size: 2.5em; }

  /* THEME 2009 */
  .theme-2009 { font-family: 'Comic Sans MS', cursive, sans-serif !important; background: #00008b !important; color: #ffff00; }
  .theme-2009 .panel, .theme-2009 .modal-box { border: 3px double #fff; background: #0000AA; }
  .theme-2009 button { border: 2px outset #ccc; background: #ccc; color: black; border-radius: 0; }
</style>
<link rel="stylesheet" href="/index.css">
</head>
<body>

<div class="overlay"></div>

<!-- HEADER -->
<h1 id="gameTitle">–ì–Ω–µ–≤ –ü–∏—Ü—Ü–∞–π–æ–ª–æ</h1>

<div class="top-bar">
    <div class="npc-container" style="position: relative;">
        <div class="npc-avatar" onclick="openNPC()">üë®‚Äçüç≥</div>
        <div id="npcQuestMark" class="npc-quest-mark"></div>
        <div style="font-size: 0.8em; margin-top: 5px;">–ë—ã–≤—à–∏–π<br>–ü–∏—Ü—Ü–∞–π–æ–ª–æ</div>
    </div>
    
    <div>
        <div>–ü–∏—Ü—Ü–∞–∫–æ–∏–Ω—ã: <span id="coins">0</span></div>
        <button id="addCoinBtn">üçï –ö–õ–ò–ö üçï</button>
    </div>
</div>

<div id="activePathDisplay" style="color: var(--tp-color); font-size: 0.9em; margin-bottom: 10px; display:none;">
    –ü—É—Ç—å: <span id="pathName">–ù–µ—Ç</span>
</div>

<div style="margin-bottom: 20px;">
  <button class="nav-btn" onclick="saveGame(true)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button class="nav-btn" onclick="openAchievements()">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
  <button class="nav-btn" style="background: #e74c3c;" onclick="startNinjaGame()">‚öîÔ∏è Pizza Ninja</button>
  <button class="nav-btn" style="background: #f1c40f; color: #000;" onclick="startTutorial()">‚ùì –¢—É—Ç–æ—Ä–∏–∞–ª</button>
</div>

<div style="margin-bottom: 20px;">
    <input type="text" id="codeInput" class="input-code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: PIZZA)">
    <button class="nav-btn" onclick="submitCode()">OK</button>
    <button id="adminBtn" class="nav-btn" style="background: #c0392b; display:none;" onclick="openAdmin()">üîß –ê–¥–º–∏–Ω</button>
</div>

<input type="file" id="modFileInput" style="display:none" accept=".pizzamod,.zip">
<button class="nav-btn" style="background: #8e44ad; display:none;" onclick="document.getElementById('modFileInput').click()" id="modLoadBtn">üì¶ –ú–æ–¥—ã</button>

<!-- CAT HOUSE -->
<div id="catHouse">
    <h3>–î–æ–º –ö–æ—Ç–∏–∫–∞</h3>
    <div style="display:flex; align-items:center; justify-content:center; gap:20px;">
        <div class="cat-main" onclick="feedCat()">üêà</div>
        <div style="text-align:left;">
            <div>–°—ã—Ç–æ—Å—Ç—å: <span id="catFed">0</span>/5</div>
            <div>–ö–æ—Ç—è—Ç: <span id="kittenCount">0</span></div>
            <button class="nav-btn" style="background:#e67e22" onclick="feedCat()">üêü –ü–æ–∫–æ—Ä–º–∏—Ç—å (50 –º–æ–Ω–µ—Ç)</button>
        </div>
    </div>
    
    <div style="margin-top:15px; border-top:1px dashed #555; padding-top:5px;">
        <small style="color:#aaa;">–í–∞—à–∏ –∫–æ—Ç—è—Ç–∞ –∏ –±–æ–Ω—É—Å—ã:</small>
        <div id="kittensList" class="kittens-container"></div>
    </div>
</div>

<!-- SHOP SECTION -->
<div class="panel">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2>–ú–∞–≥–∞–∑–∏–Ω –ö–ª–∞—Å—Å–æ–≤</h2>
    <button onclick="openPartySelect(false)" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; font-size: 1.2em; border-radius: 8px; cursor: pointer;">‚öîÔ∏è –í –ë–û–ô</button>
  </div>
  <p>–°–æ–±–µ—Ä–∏—Ç–µ 3 –∫–ª–∞—Å—Å–∞ –¥–ª—è –±–∏—Ç–≤—ã!</p>
  <div id="shopList" class="shop-grid"></div>
</div>

<div class="panel">
  <h2>–£–ª—É—á—à–µ–Ω–∏–µ –ö–ª–∞—Å—Å–æ–≤</h2>
  <p>–ü–æ–≤—ã—à–∞–π—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤</p>
  <div id="upgradeList" class="shop-grid"></div>
</div>

<div class="panel">
  <h2>–ú–∞–≥–∞–∑–∏–Ω –ü—Ä–µ–¥–º–µ—Ç–æ–≤</h2>
  <div id="itemShopList" class="shop-grid"></div>
</div>

<!-- PARTY SELECT MODAL -->
<div id="partySelectModal">
  <div class="select-container">
    <h2 id="partySelectTitle">–í—ã–±–µ—Ä–∏—Ç–µ 3 –±–æ–π—Ü–æ–≤</h2>
    <p id="partySelectDesc" style="color: #ccc;">–°–æ–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –æ–±—ã—á–Ω–æ–π –±–∏—Ç–≤—ã</p>
    <div id="partyGrid" class="select-grid"></div>
    <div style="display:flex; justify-content: space-between;">
        <button class="nav-btn" onclick="document.getElementById('partySelectModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
        <button id="confirmBattleBtn" class="nav-btn" style="background: var(--hp-color);" onclick="confirmBattle()">–ù–ê–ß–ê–¢–¨ –ë–ò–¢–í–£</button>
    </div>
  </div>
</div>

<!-- NPC MODAL -->
<div id="npcModal" class="modal">
    <div class="modal-box" style="text-align: center;">
        <h3>–ë—ã–≤—à–∏–π –ü–∏—Ü—Ü–∞–π–æ–ª–æ</h3>
        <div class="speech-bubble" id="npcText">–ü—Ä–∏–≤–µ—Ç! –Ø —Ç—É—Ç —Ä–∞–Ω—å—à–µ –≤—Å–µ–º –∑–∞–ø—Ä–∞–≤–ª—è–ª.</div>
        <div style="font-size: 4em;">üë®‚Äçüç≥</div>
        <div style="margin-top: 20px; display: grid; gap: 10px;">
            <button class="nav-btn" style="background: #27ae60;" onclick="openQuests()">üìú –ö–≤–µ—Å—Ç—ã</button>
            <button class="nav-btn" onclick="npcTalk()">üí¨ –î–∞–π —Å–æ–≤–µ—Ç</button>
            <button id="npcCatBtn" class="nav-btn" style="background: #e67e22; display:none;" onclick="npcAdoptCat()">üêà –ó–∞–≤–µ—Å—Ç–∏ –∫–æ—Ç–∞ (500)</button>
            <button id="npcHelpBtn" class="nav-btn" style="background: #9b59b6; display:none;" onclick="npcEnableHelp()">üÜò –ü–æ–ø—Ä–æ—Å–∏ –ø–æ–º–æ—â–∏ –≤ –±–æ—é</button>
            <button class="nav-btn" style="background: #3498db;" onclick="openPaths()">üîÆ –í—ã–±—Ä–∞—Ç—å –ü—É—Ç—å</button>
            <button id="dinoBtn" class="nav-btn" style="background: #555; display:none; border:2px dashed #888;" onclick="startDinoBattle()">‚è≥ –ü–æ—Ä—Ç–∞–ª –≤ –ú–µ–∑–æ–∑–æ–π</button>
            <button class="nav-btn" style="background: #e67e22;" onclick="npcSparring()">ü•ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –±–æ–π</button>
            <button class="nav-btn" style="background: #c0392b; border: 2px solid #fff;" onclick="startBossRushSetup()">‚ò†Ô∏è –ò–°–ü–´–¢–ê–ù–ò–ï: BOSS RUSH</button>
            <button id="storyBtn" class="nav-btn" style="background: #000; color: gold; border: 1px solid gold; display:none;" onclick="triggerEnding()">üëÅÔ∏è –ò–°–¢–ò–ù–ê</button>
            <button class="nav-btn" onclick="document.getElementById('npcModal').style.display='none'">üëã –ü–æ–∫–∞</button>
        </div>
    </div>
</div>

<!-- QUESTS MODAL -->
<div id="questModal" class="modal">
    <div class="modal-box">
        <h3>–°—é–∂–µ—Ç–Ω—ã–µ –ó–∞–¥–∞–Ω–∏—è</h3>
        <p>–í—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞–Ω–∏—è —á—Ç–æ–±—ã –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Å—é–∂–µ—Ç—É –∏ –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã—Ö –±–æ—Å—Å–æ–≤.</p>
        <div id="questListContainer" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="nav-btn" style="margin-top:10px; width:100%" onclick="document.getElementById('questModal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<!-- PATHS MODAL -->
<div id="pathsModal" class="modal">
    <div class="modal-box">
        <h3>–í—ã–±–æ—Ä –ü—É—Ç–∏</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é. –≠—Ç–æ —É—Å–∏–ª–∏—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ –¥–∞—Å—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã.</p>
        
        <div class="path-option" onclick="selectPath('warrior')">
            <div class="path-icon">‚öîÔ∏è</div>
            <div>
                <b>–ü—É—Ç—å –í–æ–∏–Ω–∞</b><br>
                <small>–í—Å–µ –∫–ª–∞—Å—Å—ã: –ê—Ç–∞–∫–∞ +20%<br>–£–±–æ—Ä—â–∏–∫: –ê—Ç–∞–∫–∞ +50%</small>
            </div>
        </div>
        
        <div class="path-option" onclick="selectPath('healer')">
            <div class="path-icon">ü•ó</div>
            <div>
                <b>–ü—É—Ç—å –¶–µ–ª–∏—Ç–µ–ª—è</b><br>
                <small>–í—Å–µ –∫–ª–∞—Å—Å—ã: HP +20%<br>–ü–æ–≤–∞—Ä: –ú–µ–≥–∞-—Ö–∏–ª–ª —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ</small>
            </div>
        </div>
        
        <div class="path-option" onclick="selectPath('wealth')">
            <div class="path-icon">üí∞</div>
            <div>
                <b>–ü—É—Ç—å –ë–æ–≥–∞—Ç—Å—Ç–≤–∞</b><br>
                <small>–ú–æ–Ω–µ—Ç—ã +20%<br>–ë–æ—Å—Å: –ù–∞–≤—ã–∫ —Å—Ç–æ–∏—Ç –Ω–∞ 10 TP –º–µ–Ω—å—à–µ</small>
            </div>
        </div>

        <div class="path-option" onclick="selectPath('tank')">
            <div class="path-icon">üõ°Ô∏è</div>
            <div>
                <b>–ü—É—Ç—å –¢–∞–Ω–∫–∞</b><br>
                <small>–í—Å–µ –∫–ª–∞—Å—Å—ã: HP +50%<br>–ó–∞—â–∏—Ç–∞ (Defend) —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –≤ 2 —Ä–∞–∑–∞</small>
            </div>
        </div>

        <div class="path-option" onclick="selectPath('ninja')">
            <div class="path-icon">üí®</div>
            <div>
                <b>–ü—É—Ç—å –°–∫–æ—Ä–æ—Å—Ç–∏</b><br>
                <small>15% —à–∞–Ω—Å —É–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –ª—é–±–æ–π –∞—Ç–∞–∫–∏<br>–ü–∏—Ü—Ü–∞-–ù–∏–Ω–¥–∑—è: +50% –ê—Ç–∞–∫–∞</small>
            </div>
        </div>

        <div class="path-option" onclick="selectPath('mage')">
            <div class="path-icon">‚ú®</div>
            <div>
                <b>–ü—É—Ç—å –ú–∞–≥–∏–∏</b><br>
                <small>–í—Å–µ –Ω–∞–≤—ã–∫–∏ (Special) +30% –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å<br>–†–µ–≥–µ–Ω 5 TP –∫–∞–∂–¥—ã–π —Ö–æ–¥</small>
            </div>
        </div>

        <button class="nav-btn" style="margin-top:10px; width:100%" onclick="document.getElementById('pathsModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<!-- ACHIEVEMENTS MODAL -->
<div id="achievementsModal" class="modal">
    <div class="modal-box">
        <h3>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
        <div id="achList"></div>
        <button class="nav-btn" style="margin-top: 10px;" onclick="document.getElementById('achievementsModal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<!-- ALIEN EVENT MODAL -->
<div id="alienModal" class="modal" style="display:none; flex-direction: column;">
    <div class="alien-text" style="color: #0f0; text-align: center;">
        <h1 style="color: #0f0; text-shadow: 0 0 10px #0f0;">‚ö†Ô∏è –ü–û–•–ò–©–ï–ù–ò–ï! ‚ö†Ô∏è</h1>
        <p>–í–∞—Å —Å—Ö–≤–∞—Ç–∏–ª–∏ –∏–Ω–æ–ø–ª–∞–Ω–µ—Ç—è–Ω–µ!</p>
        <p>–ù–∞–±–µ—Ä–∏—Ç–µ 2000 –º–∞–∫–∞—Ä–æ–Ω–æ–∫–æ–∏–Ω–æ–≤, —á—Ç–æ–±—ã —Å–±–µ–∂–∞—Ç—å.</p>
        <p>–¢–µ–∫—É—â–∏–µ –º–∞–∫–∞—Ä–æ–Ω—ã: <span id="macaroniCount">0</span>/2000</p>
    </div>
    <div id="macaroniBtn" onclick="clickMacaroni()" style="font-size: 100px; cursor: pointer;">üçù</div>
</div>

<!-- ADMIN MODAL -->
<div id="adminModal" class="modal">
    <div class="modal-box">
        <h3 style="color:red;">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å v2.0</h3>
        
        <div style="border: 1px solid #444; padding: 10px; margin-bottom: 10px;">
            <h4>–ß–∏—Ç—ã</h4>
            <button class="nav-btn" onclick="gameState.coins+=5000; updateUI();">üí∞ +5000 –ú–æ–Ω–µ—Ç</button>
            <button class="nav-btn" onclick="unlockAllClasses()">üîì –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ –∫–ª–∞—Å—Å—ã</button>
            <button class="nav-btn" onclick="adminGodMode()">üëº –†–µ–∂–∏–º –ë–æ–≥–∞ (–í –±–æ—é)</button>
            <button class="nav-btn" onclick="adminWinBattle()">‚öîÔ∏è –í—ã–∏–≥—Ä–∞—Ç—å –±–æ–π</button>
        </div>

        <div style="border: 1px solid #444; padding: 10px; margin-bottom: 10px;">
            <h4>–í—ã–¥–∞—á–∞ –ö–ª–∞—Å—Å–∞</h4>
            <select id="adminClassSelect" style="width: 100%; padding: 5px; margin-bottom: 5px; background: #333; color: white;">
                <!-- Options added via JS -->
            </select>
            <button class="nav-btn" onclick="adminGiveClass()">–í—ã–¥–∞—Ç—å</button>
        </div>
        
        <div style="border: 1px solid #444; padding: 10px; margin-bottom: 10px;">
            <h4>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ö–æ–¥–æ–≤</h4>
            <input id="adminNewCode" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (–Ω–∞–ø—Ä. GIFT)" style="width:100%; margin-bottom:5px;">
            <input id="adminCodeCoins" placeholder="–°—É–º–º–∞ –º–æ–Ω–µ—Ç" type="number" style="width:100%; margin-bottom:5px;">
            <select id="adminCodeClass" style="width: 100%; padding: 5px; margin-bottom: 5px; background: #333; color: white;">
                <option value="">-- –ë–µ–∑ –∫–ª–∞—Å—Å–∞ --</option>
            </select>
            <button class="nav-btn" onclick="adminGenerateCode()">–°–æ–∑–¥–∞—Ç—å –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ö–æ–¥</button>
        </div>

        <button class="nav-btn" onclick="triggerAlienEvent()">üëΩ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ü–æ—Ö–∏—â–µ–Ω–∏–µ</button>
        <button class="nav-btn" onclick="resetGame()">üóëÔ∏è –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        <button class="nav-btn" style="margin-top: 10px;" onclick="document.getElementById('adminModal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<!-- BATTLE UI -->
<div id="battleModal">
  <div id="battleContainer">
    <div class="battle-header">
      <div id="battleTitleText" style="font-size: 1.5em; color: var(--primary-color);">–ë–∏—Ç–≤–∞</div>
      <button class="nav-btn" style="background: #e74c3c;" onclick="exitBattle()">–°–±–µ–∂–∞—Ç—å</button>
    </div>
    
    <div class="battle-field">
      <div class="battle-overlay"></div>
      
      <!-- PLAYER SIDE -->
      <div id="partySlots" class="party-slots"></div>
      
      <!-- ENEMY SIDE -->
      <div id="enemySlots" class="enemy-slots"></div>
    </div>
    
    <div class="battle-controls">
      <div class="actions-grid">
        <button id="btnAtk" class="action-btn btn-atk" onclick="playerAction('attack')">–ê—Ç–∞–∫–∞</button>
        <button id="btnSkl" class="action-btn btn-skl" onclick="playerAction('special')">–ù–∞–≤—ã–∫</button>
        <button id="btnDef" class="action-btn btn-def" onclick="playerAction('defend')">–ó–∞—â–∏—Ç–∞</button>
        <button id="btnItm" class="action-btn btn-itm" onclick="playerAction('item')">–ü—Ä–µ–¥–º–µ—Ç</button>
        
        <!-- DYNAMIC MOUNT BUTTON -->
        <button id="btnMount" class="action-btn btn-mount" style="display:none" onclick="playerAction('mount')">ü¶ñ –û–°–ï–î–õ–ê–¢–¨</button>
      </div>
      <div style="display: flex; flex-direction: column;">
        <div style="margin-bottom: 5px;">–•–æ–¥: <span id="turnIndicator" style="color: var(--primary-color)">–ò–≥—Ä–æ–∫</span></div>
        <div style="margin-bottom: 5px;">TP –û—Ç—Ä—è–¥–∞: <span id="tpText">0</span>/100</div>
        <div class="hp-bar-bg"><div id="tpBar" class="hp-fill" style="background: var(--tp-color); width: 0%"></div></div>
        <div id="battleLog"></div>
      </div>
    </div>
  </div>
</div>

<!-- NINJA GAME UI -->
<div id="ninjaModal">
    <div class="ninja-ui">
        –û—á–∫–∏: <span id="ninjaScore">0</span>
    </div>
    <div id="ninjaGameArea" style="position:absolute; width:100%; height:100%;"></div>
    <div style="position: absolute; bottom: 20px; width: 100%; text-align: center;">
        <button class="nav-btn" onclick="endNinjaGame()">–í—ã—Ö–æ–¥</button>
    </div>
</div>

<!-- TUTORIAL MODAL -->
<div id="tutorialModal" class="modal" style="display:none; position:fixed; z-index:5000; inset:0; background:rgba(0,0,0,0.85); justify-content:center; align-items:center;">
    <div style="background:#fff; color:#000; padding:30px; border-radius:10px; max-width:500px; text-align:left;">
        <h2 style="color:#000;">üçï –û–±—É—á–µ–Ω–∏–µ</h2>
        <p>–ü—Ä–∏–≤–µ—Ç, –ü–∏—Ü—Ü–∞–π–æ–ª–æ! –ú–∏—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è.</p>
        <p>1. <b>–ö–ª–∏–∫–∞–π</b> –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –º–æ–Ω–µ—Ç—ã. –ó–∞–≤–µ–¥–∏ –∫–æ—Ç–∞ (–∫–æ–¥ CATS) –¥–ª—è –ø–æ–º–æ—â–∏!</p>
        <p>2. <b>–ü–æ–∫—É–ø–∞–π –∫–ª–∞—Å—Å—ã</b>. –í—ã–±–µ—Ä–∏ –ü—É—Ç—å —É –ù–ü–° —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å —Å–∏–ª—å–Ω–µ–µ.</p>
        <p>3. <b>–£—Ä–æ–≤–µ–Ω—å –±–∏—Ç–≤</b> –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è —Ç–≤–æ–∏—Ö –±–æ–π—Ü–æ–≤.</p>
        <p>4. <b>–°—é–∂–µ—Ç–Ω—ã–µ –ë–æ—Å—Å—ã</b>: –í—ã–ø–æ–ª–Ω—è–π –∫–≤–µ—Å—Ç—ã, —á—Ç–æ–±—ã –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å –∏—Ö –ø–æ –ø–æ—Ä—è–¥–∫—É.</p>
        <p>5. <b>–ì–ù–ï–í (SWOON)</b>. –ö–æ–≥–¥–∞ –±–æ–µ—Ü –æ—Å—Ç–∞–µ—Ç—Å—è –æ–¥–∏–Ω, –æ–Ω –ø–æ–ª—É—á–∞–µ—Ç –æ–≥—Ä–æ–º–Ω—É—é —Å–∏–ª—É!</p>
        <p>6. <b>–°–ø–∞—Å–µ–Ω–∏–µ –†–∞–±–æ–≤</b>. –ù–µ —É–±–∏–≤–∞–π—Ç–µ –ü–∏—Ü—Ü–∞ –†–∞–±–∞! –£–±–µ–π—Ç–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö, –∏ –æ–Ω –±—É–¥–µ—Ç —Å–ø–∞—Å–µ–Ω.</p>
        <button onclick="document.getElementById('tutorialModal').style.display='none'; checkAchievements()" style="margin-top:20px; padding:10px; background:green; color:white; border:none; cursor:pointer; width:100%; font-size:1.2em;">–ü–æ–Ω—è—Ç–Ω–æ, –≤ –±–æ–π!</button>
    </div>
</div>

<script>
// ==========================================
// DATA: FULL CONTENT
// ==========================================

const shopItems = [
    { name: "–ø–∏—Ü—Ü–∞ —É–±–æ—Ä—â–∏–∫", price: 120, hp: 40, atk: 5, autoClick: 0, special: {name: "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è –£–±–æ—Ä–∫–∞", cost: 100, desc: "–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ—Ç –æ–±—ã—á–Ω–æ–≥–æ –≤—Ä–∞–≥–∞"} },
    { name: "–ø–æ–≤–∞—Ä", price: 150, hp: 60, atk: 8, autoClick: 0, special: {name: "–ú–µ–≥–∞-—Ö–∏–ª–ª", cost: 50, desc: "–ü–æ–ª–Ω–æ—Å—Ç—å—é –ª–µ—á–∏—Ç —Å–µ–±—è"} },
    { name: "–∫–∞—Å—Å–∏—Ä", price: 180, hp: 45, atk: 6, autoClick: {amount:1, interval:30000}, special: {name: "–ë—ã—Å—Ç—Ä–∞—è —Å–¥–∞—á–∞", cost: 15, desc: "–£—Ä–æ–Ω + –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ 10 TP"} },
    { name: "–¥–æ—Å—Ç–∞–≤—â–∏–∫", price: 200, hp: 55, atk: 12, autoClick: 0, special: {name: "–í–Ω–µ–∑–∞–ø–Ω—ã–π —É–¥–∞—Ä", cost: 30, desc: "–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–Ω + –®–∞–Ω—Å –æ–≥–ª—É—à–µ–Ω–∏—è"} },
    { name: "—Å–æ—É—Å—å–µ", price: 220, hp: 50, atk: 10, autoClick: 0, special: {name: "–û—Å—Ç—Ä—ã–π —Å–æ—É—Å", cost: 25, desc: "–£—Ä–æ–Ω + –ü–æ–¥–∂–æ–≥ –Ω–∞ 3 —Ö–æ–¥–∞"} },
    { name: "–±–æ—Å—Å", price: 250, hp: 80, atk: 15, autoClick: {amount:3, interval:20000}, special: {name: "–ú–æ—Ç–∏–≤–∞—Ü–∏—è", cost: 40, desc: "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 40 TP"} },
    { name: "–∫–æ—Ä–æ–ª—å –ø–∏—Ü—Ü—ã", price: 300, hp: 100, atk: 18, autoClick: 0, special: {name: "–ü—Ä–∏–∑—ã–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", cost: 60, desc: "–ê—Ç–∞–∫–∞ —Å–ª—É—á–∞–π–Ω—ã–º –∫–ª–∞—Å—Å–æ–º"} },
    { name: "—Ñ—É–¥-–∫—Ä–∏—Ç–∏–∫", price: 400, hp: 40, atk: 5, autoClick: 0, special: {name: "–†–∞–∑–≥—Ä–æ–º–Ω—ã–π –æ–±–∑–æ—Ä", cost: 25, desc: "–°–Ω–∏–∂–∞–µ—Ç –∞—Ç–∞–∫—É –≤—Ä–∞–≥–∞ –Ω–∞ 30%"} },
    { name: "–ø–∏—Ü—Ü–∞ –∞–¥–≤–æ–∫–∞—Ç", price: 450, hp: 60, atk: 14, autoClick: 0, special: {name: "–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ!", cost: 30, desc: "–£—Ä–æ–Ω + –í—ã—Å–æ–∫–∏–π —à–∞–Ω—Å –æ–≥–ª—É—à–µ–Ω–∏—è"} },
    { name: "–ø–∏—Ü—Ü–∞-–Ω–∏–Ω–¥–∑—è", price: 500, hp: 70, atk: 25, autoClick: {amount:5, interval:1000}, special: {name: "–¢—ã—Å—è—á–∞ —Ä–∞–∑—Ä–µ–∑–æ–≤", cost: 50, desc: "–ú–∞—Å—Å–∏–≤–Ω—ã–π —É—Ä–æ–Ω"} },
    { name: "–∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π –º–∞–≥", price: 600, hp: 50, atk: 30, autoClick: {amount:5, interval:15000}, special: {name: "–°—ã—Ä–Ω—ã–π –º–µ—Ç–µ–æ—Ä", cost: 40, desc: "–ú–æ—â–Ω—ã–π –º–∞–≥–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω"} },
    { name: "–æ—Ö–æ—Ç–Ω–∏–∫ –∑–∞ –ø–∏—Ü—Ü–µ–π", price: 700, hp: 85, atk: 22, autoClick: 0, special: {name: "–û—Ç—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø–∏—Ü—Ü–∞", cost: 45, desc: "–°–∏–ª—å–Ω—ã–π —è–¥ (3 —Ö–æ–¥–∞)"} },
    { name: "–ø–∏—Ü—Ü–∞ –±–æ—Ç", price: 800, hp: 120, atk: 20, autoClick: {amount:10, interval:10000}, special: {name: "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è", cost: 35, desc: "–õ–µ—á–∏—Ç –æ—Ç—Ä—è–¥ + TP"} },
    { name: "–∫–æ–Ω–¥–∏—Ç–µ—Ä-–±–µ—Ä—Å–µ—Ä–∫", price: 900, hp: 90, atk: 40, autoClick: 0, special: {name: "–°–∞—Ö–∞—Ä–Ω—ã–π –†–∞—à", cost: 60, desc: "–û–≥—Ä–æ–º–Ω—ã–π —É—Ä–æ–Ω —Ü–µ–Ω–æ–π —Å–≤–æ–µ–≥–æ HP"} },
    { name: "–ø–∏—Ü—Ü–∞-–±–∞—Ä–¥", price: 1100, hp: 60, atk: 10, autoClick: 0, special: {name: "–ë–æ–¥—Ä—è—â–∞—è –ü–µ—Å–Ω—è", cost: 40, desc: "–ü–æ–≤—ã—à–∞–µ—Ç –∞—Ç–∞–∫—É –æ—Ç—Ä—è–¥–∞"} },
    { name: "—Ç–µ—Å—Ç–æ-–≥–æ–ª–µ–º", price: 1200, hp: 200, atk: 15, autoClick: 0, special: {name: "–ö–∞–º–µ–Ω–Ω–∞—è –ö–æ—Ä–æ—á–∫–∞", cost: 30, desc: "–°–Ω–∏–∂–∞–µ—Ç —É—Ä–æ–Ω –ø–æ —Å–µ–±–µ"} },
    { name: "–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞", price: 1300, hp: 70, atk: 18, autoClick: 0, special: {name: "–ê–∫—Ç –æ –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏", cost: 35, desc: "–£—Ä–æ–Ω + –°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—â–∏—Ç—ã"} },
    { name: "—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä", price: 2000, hp: 60, atk: 10, autoClick: {amount:15, interval:25000}, special: {name: "–í—Ä–∞–∂–¥–µ–±–Ω–æ–µ –ü–æ–≥–ª–æ—â–µ–Ω–∏–µ", cost: 60, desc: "–£—Ä–æ–Ω + –ö—Ä–∞–∂–∞ –º–æ–Ω–µ—Ç"} },
    
    // NEW CLASSES
    { name: "–∫–∏–±–µ—Ä-–ø–µ–∫–∞—Ä—å", price: 3000, hp: 150, atk: 30, autoClick: {amount: 20, interval: 8000}, special: {name: "–õ–∞–∑–µ—Ä–Ω–∞—è –Ω–∞—Ä–µ–∑–∫–∞", cost: 55, desc: "–ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∑–∞—â–∏—Ç—É –≤—Ä–∞–≥–∞"} },
    { name: "–≤–∞–º–ø–∏—Ä-–æ—Ñ–∏—Ü–∏–∞–Ω—Ç", price: 4000, hp: 100, atk: 25, autoClick: 0, special: {name: "–ö—Ä–æ–≤–∞–≤—ã–π —Å–æ–∫", cost: 40, desc: "–ö—Ä–∞–¥–µ—Ç HP —É –≤—Ä–∞–≥–∞"} },
    { name: "–≤–ª–∞–¥—ã–∫–∞ –≤—Ä–µ–º–µ–Ω–∏", price: 5000, hp: 80, atk: 10, autoClick: 0, special: {name: "–ü–µ—Ä–µ—Ä—ã–≤", cost: 80, desc: "–û–≥–ª—É—à–∞–µ—Ç –≤—Å–µ—Ö –≤—Ä–∞–≥–æ–≤ –Ω–∞ 2 —Ö–æ–¥–∞"} },
    
    // BEASTMASTER
    { name: "–ø–æ–≤–µ–ª–∏—Ç–µ–ª—å –∑–≤–µ—Ä–µ–π", price: 3500, hp: 90, atk: 15, autoClick: 0, special: {name: "–£–∫—Ä–æ—â–µ–Ω–∏–µ", cost: 40, desc: "–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏—Ä—É—á–∏—Ç—å –∑–≤–µ—Ä—è –∏–ª–∏ —Å—Ç–∞–Ω"} },

    // SECRET CLASSES
    { name: "–∫—É—Ä—å–µ—Ä-–ø—Ä–∏–∑—Ä–∞–∫", price: 1500, hp: 50, atk: 35, autoClick: 0, special: {name: "–ü—Ä–∏–∑—Ä–∞—á–Ω–∞—è –î–æ—Å—Ç–∞–≤–∫–∞", cost: 50, desc: "–ö—Ä–∏—Ç + –£–≤–æ—Ä–æ—Ç"}, isSecret: true },
    { name: "–¥—Ä–∞–∫–æ–Ω –ø–∏—Ü—Ü—ã", price: 999999, hp: 500, atk: 100, autoClick: {amount:100, interval:5000}, special: {name: "–û–≥–Ω–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ", cost: 70, desc: "–ö–æ–ª–æ—Å—Å–∞–ª—å–Ω—ã–π —É—Ä–æ–Ω –ø–æ –≤—Å–µ–º"}, isSecret: true },
    { name: "–ø–∏—Ü—Ü–∞ –∫—Ä–∞—Ç–æ—Å", price: 10000, hp: 300, atk: 80, autoClick: 0, special: {name: "–ì–Ω–µ–≤ –°–ø–∞—Ä—Ç—ã", cost: 80, desc: "–£—Ä–æ–Ω –æ–≥–Ω–µ–º –∏ –ª—å–¥–æ–º"}, isSecret: true },
    { name: "–ü–∏—Ü—Ü–∞ –†–∞–±", price: 999, hp: 50, atk: 5, autoClick: 0, special: {name: "–ü–∏—Ü—Ü–∞ –°–≤–æ–±–æ–¥—ã", cost: 35, desc: "–õ–µ—á–∏—Ç –≤–µ—Å—å –æ—Ç—Ä—è–¥"}, isSecret: true },
    { name: "–ó–≤—ë–∑–¥–Ω—ã–π –ü–∏—Ü—Ü–∞–π–æ–ª–æ", price: 9999, hp: 250, atk: 60, autoClick: {amount:25, interval:10000}, special: {name: "–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–ø—Ä–∞–≤–∞", cost: 50, desc: "–ú–∞—Å—Å–æ–≤—ã–π —É—Ä–æ–Ω + –°—Ç–∞–Ω"}, isSecret: true },
    { name: "–ö—Ä–∏—Å", price: 0, hp: 150, atk: 30, autoClick: 0, special: {name: "–û—Ç–≤–∞–≥–∞", cost: 15, desc: "–ó–∞—â–∏—Ç–∞ + TP"}, isSecret: true },
    { name: "–°—å—é–∑–∏", price: 0, hp: 200, atk: 40, autoClick: 0, special: {name: "–ì—Ä—É–±—ã–π –≤—ã–ø–∞–¥", cost: 40, desc: "–¢—è–∂–µ–ª—ã–π —É–¥–∞—Ä"}, isSecret: true },
    { name: "–†–∞–ª—å–∑–µ–π", price: 0, hp: 120, atk: 20, autoClick: 0, special: {name: "–ú–æ–ª–∏—Ç–≤–∞", cost: 30, desc: "–õ–µ—á–µ–Ω–∏–µ –æ—Ç—Ä—è–¥–∞"}, isSecret: true }
];

const items = [
    { name: "–ö—É—Å–æ—á–µ–∫ –ø–∏—Ü—Ü—ã", price: 25, effect: "heal_50" },
    { name: "–ì–∞–∑–∏—Ä–æ–≤–∫–∞", price: 30, effect: "tp_30" },
    { name: "–ü–µ–ø–ø–µ—Ä–æ–Ω–∏", price: 50, effect: "buff_atk" },
    { name: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –°–∫–∞–ª–∫–∞", price: 0, isSecret: true, desc: "–°–ò–õ–ê –ü–†–ï–î–ö–û–í! (+50% –î–æ—Ö–æ–¥, +20% –ê—Ç–∞–∫–∞)" },
    { name: "–ü–æ–≤–æ–¥—å—è –ü–∏—Ü—Ü–∞–∑–∞–≤—Ä–∞", price: 0, isSecret: true, desc: "–ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Å–µ–¥–ª–∞—Ç—å –ü–∏—Ü—Ü–∞–∑–∞–≤—Ä–∞ –≤ –±–æ—é" }
];

// UPDATED QUESTS FOR STORY
const quests = [
    { id: 'q1', text: "–ù–∞–∫–æ–ø–∏ 500 –º–æ–Ω–µ—Ç", reward: 200, check: (s) => s.coins >= 500 },
    { id: 'q2', text: "–ü–æ–±–µ–¥–∏ –ö—Ä–∞–∫–µ–Ω–∞-–ö–∞–ª—å–º–∞—Ä–∞ (–ë–æ—Å—Å 1)", reward: 1000, check: (s) => (s.stats.bossesDefeated||[]).includes("–ö—Ä–∞–∫–µ–Ω-–ö–∞–ª—å–º–∞—Ä") },
    { id: 'q3', text: "–ö—É–ø–∏ 3 –∫–ª–∞—Å—Å–∞ –∏ –ø—Ä–æ–∫–∞—á–∞–π –∏—Ö", reward: 500, check: (s) => s.ownedClasses.length >= 3 && Object.values(s.classLevels).some(l=>l>=2) },
    { id: 'q4', text: "–ü–æ–±–µ–¥–∏ –ê–≤—Ç–æ–±—É—Å –ö–ª–∏–µ–Ω—Ç–æ–≤ (–ë–æ—Å—Å 2)", reward: 1500, check: (s) => (s.stats.bossesDefeated||[]).includes("–ê–≤—Ç–æ–±—É—Å –ö–ª–∏–µ–Ω—Ç–æ–≤") },
    { id: 'q5', text: "–û—Å–≤–æ–±–æ–¥–∏ –ü–∏—Ü—Ü–∞ –†–∞–±–∞", reward: 800, check: (s) => s.ownedClasses.includes("–ü–∏—Ü—Ü–∞ –†–∞–±") },
    { id: 'q6', text: "–ü–æ–±–µ–¥–∏ –ú–∞—Ç–∫—É –ê–Ω–æ–º–∞–ª–æ—Ä–æ–Ω–∏ (–ë–æ—Å—Å 3)", reward: 2000, check: (s) => (s.stats.bossesDefeated||[]).includes("–ú–∞—Ç–∫–∞ –ê–Ω–æ–º–∞–ª–æ—Ä–æ–Ω–∏") },
    { id: 'q7', text: "–ü–æ–±–µ–¥–∏ –ë—É—Ä–≥–µ—Ä –°–∞–º—É—Ä–∞—è (–ë–æ—Å—Å 4)", reward: 3000, check: (s) => (s.stats.bossesDefeated||[]).includes("–ë—É—Ä–≥–µ—Ä –°–∞–º—É—Ä–∞–π") },
    { id: 'q8', text: "–ü–æ–±–µ–¥–∏ –ö–∞–º—É—Ñ–ª—è–∂–Ω–æ–≥–æ –ë—É—Ä–≥–µ—Ä–∞ (–ë–æ—Å—Å 5)", reward: 4000, check: (s) => (s.stats.bossesDefeated||[]).includes("–ö–∞–º—É—Ñ–ª—è–∂–Ω—ã–π –ë—É—Ä–≥–µ—Ä") },
    { id: 'q9', text: "–í—ã–±–µ—Ä–∏ –ü—É—Ç—å —É –ü–∏—Ü—Ü–∞–π–æ–ª–æ", reward: 1000, check: (s) => s.chosenPath !== null },
    { id: 'q10', text: "–ü–æ–±–µ–¥–∏ –¢–µ–Ω—å –ì–Ω–µ–≤–∞ (–§–ò–ù–ê–õ)", reward: 10000, check: (s) => (s.stats.bossesDefeated||[]).includes("–¢–µ–Ω—å –ì–Ω–µ–≤–∞ (–ë–æ—Å—Å)") }
];

const catBreeds = {
    'tabby': { name: '–†—ã–∂–∏–π', icon: 'üêà', desc: '+2 –º–æ–Ω–µ—Ç—ã –∑–∞ –∫–ª–∏–∫' },
    'siamese': { name: '–°–∏–∞–º—Å–∫–∏–π', icon: 'üêà‚Äç‚¨õ', desc: '5% –®–∞–Ω—Å –∫—Ä–∏—Ç. –∫–ª–∏–∫–∞ (x10)' },
    'persian': { name: '–ü–µ—Ä—Å–∏–¥—Å–∫–∏–π', icon: '‚òÅÔ∏è', desc: '–ê–≤—Ç–æ-–∫–ª–∏–∫–µ—Ä—ã –Ω–∞ 10% –±—ã—Å—Ç—Ä–µ–µ' },
    'mainecoon': { name: '–ú–µ–π–Ω-–∫—É–Ω', icon: 'ü¶Å', desc: '+5% –ê—Ç–∞–∫–∏ –≤ –±–æ—é' },
    'sphynx': { name: '–°—Ñ–∏–Ω–∫—Å', icon: 'üëΩ', desc: '–°–∫–∏–¥–∫–∞ 2% –≤ –º–∞–≥–∞–∑–∏–Ω–µ' }
};

let enemies = [
    { name: "–ö–∞—Ä—Ç–æ—à–∫–∞-–§—Ä–∏", hp: 100, atk: 10, reward: 50, ai: "basic", sprite: "üçü", minLevel: 0 },
    { name: "–ú–µ–ª–∫–∏–π –ê–Ω–æ–º–∞–ª–æ—Ä–æ–Ω–∏", hp: 100, atk: 15, reward: 10, ai: "basic", sprite: "üêõ", minLevel: 999 }, // Minion
    { name: "–ë—É—Ä–≥–µ—Ä-–ì–∞–Ω–≥—Å—Ç–µ—Ä", hp: 200, atk: 15, reward: 100, ai: "basic", sprite: "üçî", minLevel: 2 },
    
    // BOSS 1
    { name: "–ö—Ä–∞–∫–µ–Ω-–ö–∞–ª—å–º–∞—Ä", hp: 400, atk: 25, reward: 250, ai: "boss", sprite: "ü¶ë", minLevel: 5 },
    
    { name: "–°—É—à–∏-–†–æ–±–æ—Ç", hp: 300, atk: 20, reward: 150, ai: "healer", sprite: "üç£", minLevel: 8 },
    { name: "–†–∞–∑–≥–Ω–µ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç", hp: 350, atk: 30, reward: 120, ai: "basic", sprite: "üò°", minLevel: 10 },
    
    // BOSS 2
    { name: "–ê–≤—Ç–æ–±—É—Å –ö–ª–∏–µ–Ω—Ç–æ–≤", hp: 900, atk: 40, reward: 500, ai: "bus", sprite: "üöå", minLevel: 12 },

    { name: "–ê–Ω–∞–Ω–∞—Å–æ–≤—ã–π –ú–æ–Ω—Å—Ç—Ä", hp: 450, atk: 35, reward: 280, ai: "basic", sprite: "üçç", minLevel: 15 },
    { name: "–†–æ–±–æ—Ç-–ú–æ—Ä–æ–∑–∏–ª—å–Ω–∏–∫", hp: 500, atk: 40, reward: 300, ai: "basic", sprite: "ü§ñ", minLevel: 20 },
    { name: "–ó–æ–ª–æ—Ç–∞—è –ö—Ä—ã—Å–∞", hp: 100, atk: 0, reward: 5000, ai: "flee", sprite: "üêÄ", minLevel: 15 }, 

    // BOSS 3
    { name: "–ú–∞—Ç–∫–∞ –ê–Ω–æ–º–∞–ª–æ—Ä–æ–Ω–∏", hp: 1000, atk: 50, reward: 700, ai: "matriarch", sprite: "ü¶ê", minLevel: 25 },
    
    { name: "–ü–∏—Ü—Ü–∞-–ü—Ä–µ–¥–∞—Ç–µ–ª—å", hp: 600, atk: 55, reward: 666, ai: "traitor", sprite: "üé≠", minLevel: 28 },

    // BOSS 4
    { name: "–ë—É—Ä–≥–µ—Ä –°–∞–º—É—Ä–∞–π", hp: 800, atk: 45, reward: 400, ai: "boss", sprite: "üëπ", minLevel: 30 },
    
    // BOSS 5
    { name: "–ö–∞–º—É—Ñ–ª—è–∂–Ω—ã–π –ë—É—Ä–≥–µ—Ä", hp: 800, atk: 45, reward: 600, ai: "camo", sprite: "üçî", minLevel: 35 }, 

    { name: "–ö–æ—Ä–æ–ª–µ–≤–∞ –®–∞—Ä–ª–æ—Ç—Ç–∞", hp: 800, atk: 55, reward: 600, ai: "boss", sprite: "üßÅ", minLevel: 40 },
    { name: "–ú–µ—Ö–∞-–ü–µ—á—å 3000", hp: 1500, atk: 40, reward: 800, ai: "tank", sprite: "ü§ñ", minLevel: 45 },
    
    // FINAL BOSS
    { name: "–¢–µ–Ω—å –ì–Ω–µ–≤–∞ (–ë–æ—Å—Å)", hp: 1200, atk: 60, reward: 1000, ai: "boss_swoon", sprite: "üíÄ", minLevel: 50 },
    
    { name: "–ú–∞–Ω–µ–∫–µ–Ω", hp: 9999, atk: 0, reward: 0, ai: "dummy", sprite: "ü™µ", minLevel: 0 },
    { name: "–î—Ä–µ–≤–Ω–µ–µ –¢–µ—Å—Ç–æ", hp: 2000, atk: 20, reward: 2000, ai: "regen", sprite: "ü•Ø", minLevel: 55 },

    // SECRET BOSS
    { name: "–î–æ–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ü–æ–≤–∞—Ä", hp: 3000, atk: 80, reward: 5000, ai: "pizzasaur", sprite: "ü¶ñ", minLevel: 60, fedCount: 0 }
];

const specialEnemies = {
    god: { name: "–ë—É—Ä–≥–µ—Ä –ë–æ–≥", hp: 5000, atk: 100, reward: 5000, ai: "boss_swoon", sprite: "üëë" },
    slave: { name: "–ü–∏—Ü—Ü–∞ –†–∞–± (–í—Ä–∞–≥)", hp: 100, atk: 0, reward: 0, ai: "hostage", sprite: "ü•∫" }
};

const achievements = [
    { id: 'first_coin', name: '–ü–µ—Ä–≤—ã–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫', desc: '–ö–ª–∏–∫–Ω–∏—Ç–µ –∫–Ω–æ–ø–∫—É 1 —Ä–∞–∑' },
    { id: 'rich', name: '–ë–æ–≥–∞—á', desc: '–ù–∞–∫–æ–ø–∏—Ç–µ 1000 –º–æ–Ω–µ—Ç' },
    { id: 'squad', name: '–ö–æ–º–∞–Ω–¥–∞ –º–µ—á—Ç—ã', desc: '–ö—É–ø–∏—Ç–µ 3 –∫–ª–∞—Å—Å–∞' },
    { id: 'win_battle', name: '–ü–µ—Ä–≤–∞—è –∫—Ä–æ–≤—å', desc: '–ü–æ–±–µ–¥–∏—Ç–µ –≤ –±–æ—é' },
    { id: 'rage_mode', name: '–ì–Ω–µ–≤ –ü–∏—Ü—Ü–∞–π–æ–ª–æ', desc: '–í—ã–∂–∏–≤–∏—Ç–µ –æ–¥–Ω–∏–º –±–æ–π—Ü–æ–º –ø–æ—Å–ª–µ Swoon' },
    { id: 'full_shop', name: '–ü–æ–ª–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω', desc: '–ö—É–ø–∏—Ç—å –≤—Å–µ –∫–ª–∞—Å—Å—ã' },
    { id: 'code_finder', name: '–•–∞–∫–µ—Ä', desc: '–í–≤–µ—Å—Ç–∏ 3 –∫–æ–¥–∞' },
    { id: 'bot_master', name: '–ú–∞—Å—Ç–µ—Ä –±–æ—Ç–æ–≤', desc: '–ö—É–ø–∏—Ç—å –ü–∏—Ü—Ü–∞ –ë–æ—Ç–∞' },
    { id: 'pizza_collector', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', desc: '–ò–º–µ—Ç—å –º–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤' },
    { id: 'cheesy_life', name: '–°—ã—Ä–Ω–∞—è –∂–∏–∑–Ω—å', desc: '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—ã—Ä–Ω—ã–π –∫–æ–¥' },
    { id: 'sweet_victory', name: '–°–ª–∞–¥–∫–∞—è –ü–æ–±–µ–¥–∞', desc: '–ü–æ–±–µ–¥–∏—Ç—å –ö–æ—Ä–æ–ª–µ–≤—É –®–∞—Ä–ª–æ—Ç—Ç—É' },
    { id: 'janitor_win', name: '–ß–∏—Å—Ç–æ—Ç–∞', desc: '–ü–æ–±–µ–¥–∏—Ç—å –£–±–æ—Ä—â–∏–∫–æ–º' },
    { id: 'samurai_duel', name: '–î—É—ç–ª—å —á–µ—Å—Ç–∏', desc: '–ü–æ–±–µ–¥–∏—Ç—å –°–∞–º—É—Ä–∞—è' },
    { id: 'millionaire', name: '–ü–∏—Ü—Ü–∞-–ú–∞–≥–Ω–∞—Ç', desc: '1,000,000 –º–æ–Ω–µ—Ç' },
    { id: 'unstoppable_force', name: '–¢–∞–Ω–∫', desc: '–ö—É–ø–∏—Ç—å –¢–µ—Å—Ç–æ-–ì–æ–ª–µ–º–∞' },
    { id: 'ghost_in_the_pizzeria', name: '–ü—Ä–∏–∑—Ä–∞–∫', desc: '–ö—É–ø–∏—Ç—å –ö—É—Ä—å–µ—Ä–∞-–ü—Ä–∏–∑—Ä–∞–∫–∞' },
    { id: 'abduction_survivor', name: '–í—ã–∂–∏–≤—à–∏–π', desc: '–°–±–µ–∂–∞—Ç—å –æ—Ç –ø—Ä–∏—à–µ–ª—å—Ü–µ–≤' },
    { id: 'slave_freed', name: '–°–≤–æ–±–æ–¥–∞!', desc: '–û—Å–≤–æ–±–æ–¥–∏—Ç—å –ü–∏—Ü—Ü–∞ –†–∞–±–∞' },
    { id: 'boss_rush_complete', name: '–ë–æ–≥ –ë–∏—Ç–≤', desc: '–ü—Ä–æ–π—Ç–∏ Boss Rush' },
    { id: 'cat_lover', name: '–ö–æ—à–∞—Ç–Ω–∏–∫', desc: '–ó–∞–≤–µ—Å—Ç–∏ 5 –∫–æ—Ç—è—Ç' },
    { id: 'ninja_master', name: '–ú–∞—Å—Ç–µ—Ä –ö–ª–∏–Ω–∫–∞', desc: '–ù–∞–±—Ä–∞—Ç—å 200 –æ—á–∫–æ–≤ –≤ Pizza Ninja' },
    { id: 'legend_found', name: '–ò—Å—Ç–∏–Ω–∞', desc: '–ù–∞–π—Ç–∏ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—É—é —Å–∫–∞–ª–∫—É' },
    { id: 'dino_tamer', name: '–í—Å–∞–¥–Ω–∏–∫', desc: '–û—Å–µ–¥–ª–∞—Ç—å –ü–∏—Ü—Ü–∞–∑–∞–≤—Ä–∞' }
];

const secretCodes = {
    'PIZZA': () => { gameState.coins += 100; alert('–ö–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: +100 –º–æ–Ω–µ—Ç'); },
    'MONEY': () => { gameState.coins += 1000; alert('–ö–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: +1000 –º–æ–Ω–µ—Ç'); },
    'RAGE': () => { alert('–ì–Ω–µ–≤ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç –≤–∞—Å! (–ü–∞—Å—Ö–∞–ª–∫–∞)'); },
    'ADMIN': () => { document.getElementById('adminBtn').style.display = 'inline-block'; alert('–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω!'); },
    'FREE100': () => { gameState.coins += 100; alert('+100 –ú–æ–Ω–µ—Ç!'); },
    'PEPPERONI': () => { gameState.coins += 50; unlockClass('–ø–æ–≤–∞—Ä'); alert('+50 –º–æ–Ω–µ—Ç –∏ –ü–æ–≤–∞—Ä!'); },
    'CHEESY': () => { document.body.style.filter = 'sepia(0.5) hue-rotate(-30deg)'; unlockAch('cheesy_life'); alert('–°—ã—Ä–Ω—ã–π —Ä–µ–∂–∏–º!'); },
    'MAMMA MIA': () => { alert('Mamma Mia! (–ó–≤—É–∫ –∏–∑–º–µ–Ω–µ–Ω)'); },
    'DELTARUNE': () => { unlockClass('–ö—Ä–∏—Å'); unlockClass('–°—å—é–∑–∏'); unlockClass('–†–∞–ª—å–∑–µ–π'); alert('–†–µ–∂–∏–º –î–µ–ª—å—Ç–∞—Ä—É–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!'); },
    'ONEPLAYER': () => { alert('–í—ã –∏ —Ç–∞–∫ –æ–¥–∏–Ω...'); },
    '2009': () => { document.body.classList.add('theme-2009'); alert('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ 2009!'); },
    'MODERN': () => { document.body.classList.remove('theme-2009'); document.body.style.filter = ''; alert('–í–µ—Ä–Ω—É–ª–∏—Å—å –≤ –Ω–∞—à–µ –≤—Ä–µ–º—è.'); },
    'RETURN': () => { gameState.coins += gameState.ownedClasses.length * 100; gameState.ownedClasses = []; alert('–ö–ª–∞—Å—Å—ã –ø—Ä–æ–¥–∞–Ω—ã.'); updateUI(); },
    'FULLRESET': () => { resetGame(); },
    'MOREMONEY': () => { gameState.coins += 1; alert('–í–æ—Ç —Ç–µ–±–µ 1 –º–æ–Ω–µ—Ç–∞.'); },
    'POWERUP': () => { gameState.coins += 200; unlockClass('–¥–æ—Å—Ç–∞–≤—â–∏–∫'); },
    'EASTEREGG': () => { gameState.coins += 500; alert('–í—ã –Ω–∞—à–ª–∏ –ø–∞—Å—Ö–∞–ª–∫—É!'); },
    'GODOFPIZZA': () => { unlockClass('–ø–∏—Ü—Ü–∞ –∫—Ä–∞—Ç–æ—Å'); alert('–ë–û–ì –ü–ò–¶–¶–´ –ü–û–õ–£–ß–ï–ù'); },
    'INGREDIENTS': () => { gameState.coins += 300; alert('–î–µ–Ω—å–≥–∏ –Ω–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã.'); },
    'BIGMONEY': () => { gameState.coins += 1500; alert('–ë–æ–ª—å—à–∏–µ –¥–µ–Ω—å–≥–∏!'); },
    'GHOST': () => { unlockClass('–∫—É—Ä—å–µ—Ä-–ø—Ä–∏–∑—Ä–∞–∫'); alert('–ö—É—Ä—å–µ—Ä-–ø—Ä–∏–∑—Ä–∞–∫ –ø–æ–ª—É—á–µ–Ω'); },
    'MASTERCHEF': () => { unlockClass('–ø–æ–≤–∞—Ä'); unlockClass('—Å–æ—É—Å—å–µ'); alert('–ù–∞–±–æ—Ä –®–µ—Ñ–∞ –≤—ã–¥–∞–Ω.'); },
    'BATTLEMASTER': () => { gameState.inventory["–ö—É—Å–æ—á–µ–∫ –ø–∏—Ü—Ü—ã"] = (gameState.inventory["–ö—É—Å–æ—á–µ–∫ –ø–∏—Ü—Ü—ã"]||0) + 5; alert('–í—ã–¥–∞–Ω–∞ –ø—Ä–æ–≤–∏–∑–∏—è.'); },
    'ALCHEMY': () => { unlockClass('–∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π –º–∞–≥'); },
    'CHEESEGUARD': () => { unlockClass('—Ç–µ—Å—Ç–æ-–≥–æ–ª–µ–º'); },
    'ROCKETFUEL': () => { unlockClass('–¥–æ—Å—Ç–∞–≤—â–∏–∫'); },
    'PRESTIGE': () => { if(gameState.coins > 100000) { gameState.coins += 50000; alert('–ü—Ä–µ—Å—Ç–∏–∂ –±–æ–Ω—É—Å!'); } else alert('–ù—É–∂–Ω–æ 100–∫ –º–æ–Ω–µ—Ç.'); },
    'DINO': () => { if(gameState.ownedClasses.includes("–ø–æ–≤–µ–ª–∏—Ç–µ–ª—å –∑–≤–µ—Ä–µ–π")) { document.getElementById('dinoBtn').style.display='inline-block'; alert("–ü–æ—Ä—Ç–∞–ª –æ—Ç–∫—Ä—ã—Ç!"); } else alert("–ù—É–∂–µ–Ω –ü–æ–≤–µ–ª–∏—Ç–µ–ª—å –ó–≤–µ—Ä–µ–π!"); }
};

const npcTips = [
    "–£—Ä–æ–≤–µ–Ω—å –≤—Ä–∞–≥–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è —Ç–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã.",
    "–ü–∏—Ü—Ü–∞ –†–∞–± –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–ª–µ–Ω—É —É –ë—É—Ä–≥–µ—Ä-–ì–∞–Ω–≥—Å—Ç–µ—Ä–æ–≤. –£–±–µ–π –±–∞–Ω–¥–∏—Ç–æ–≤, –Ω–æ –Ω–µ —Ç—Ä–æ–≥–∞–π –†–∞–±–∞!",
    "–ë—É—Ä–≥–µ—Ä –ë–æ–≥ - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –±–æ—Å—Å. –û–Ω –ø–æ—è–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –ü–∏—Ü—Ü–∞ –ö—Ä–∞—Ç–æ—Å.",
    "–í—ã–ø–æ–ª–Ω—è–π –ö–≤–µ—Å—Ç—ã, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø—Ä–∞–≤–¥—É –æ–± —ç—Ç–æ–º –º–µ—Å—Ç–µ...",
    "–ö—Ä–∞–∫–µ–Ω - –ø–µ—Ä–≤—ã–π –Ω–∞—Å—Ç–æ—è—â–∏–π –±–æ—Å—Å. –ë—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω.",
    "–ê–≤—Ç–æ–±—É—Å –ö–ª–∏–µ–Ω—Ç–æ–≤ –º–æ–∂–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–µ—Ö–∞—Ç—å —Ç–≤–æ–µ–≥–æ –±–æ–π—Ü–∞!",
    "–ö–∞–º—É—Ñ–ª—è–∂–Ω—ã–π –±—É—Ä–≥–µ—Ä –ø—Ä–∏—Ç–≤–æ—Ä—è–µ—Ç—Å—è —Å–ª–∞–±—ã–º, –Ω–æ —ç—Ç–æ –ª–æ–≤—É—à–∫–∞."
];

let gameState = {
    coins: 0, ownedClasses: [], classLevels: {}, inventory: {},
    autoClickers: {}, unlockedAchievements: [], usedCodes: [],
    generatedOneTimeCodes: {}, npcHelperActive: false,
    cats: { count: 0, fed: 0, list: [] }, catActive: false, chosenPath: null,
    stats: { battlesWon: 0, bossesDefeated: [] },
    completedQuests: [], storyFinished: false
};

let battle = {
    active: false, turn: 0, tp: 0, activeCharIdx: 0, 
    party: [], enemyParty: [],
    rageMode: false, swoonTriggered: false, targetIdx: 0,
    isBossRush: false, bossRushQueue: [], godMode: false,
    pizzasaurFed: 0 // Track feeding for taming
};

let ninja = { active: false, score: 0, interval: null, elements: [] };
let alienEvent = { active: false, macaroni: 0 };

window.onload = () => {
    loadGame();
    if(gameState.ownedClasses.length === 0) startTutorial();
    renderShop(); renderUpgrades(); renderItems(); startAutoClickers();
    checkAchievements(); updateCatHouse(); updatePathDisplay(); populateAdminSelects();
    updateQuestMarker();
    
    if(gameState.ownedClasses.includes("–ø–æ–≤–µ–ª–∏—Ç–µ–ª—å –∑–≤–µ—Ä–µ–π")) document.getElementById('dinoBtn').style.display = 'inline-block';

    // MULTI-TOUCH BUTTON HANDLER
    const btn = document.getElementById('addCoinBtn');
    btn.addEventListener('pointerdown', (e) => {
        // Prevent default actions like scrolling/zooming/highlighting
        e.preventDefault(); 
        
        let gain = 1 + (gameState.ownedClasses.length);
        if(gameState.chosenPath === 'wealth') gain = Math.floor(gain * 1.2);
        
        // Cat buffs (Tabby)
        const tabbyCount = (gameState.cats.list || []).filter(c => c === 'tabby').length;
        gain += tabbyCount * 2;
        
        // Legendary Item Buff
        if((gameState.inventory["–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –°–∫–∞–ª–∫–∞"]||0) > 0) gain = Math.floor(gain * 1.5);

        // Cat buff (Siamese Crit)
        const siameseCount = (gameState.cats.list || []).filter(c => c === 'siamese').length;
        if(siameseCount > 0 && Math.random() < 0.05 * siameseCount) {
            gain *= 10;
            showDamage(e.clientX, e.clientY - 20, `CRIT!`, "orange");
        }

        gain += (gameState.cats.count || 0);
        gameState.coins += gain; updateUI();
        
        // Handle coordinates for visual effect (fallback for weird touch events)
        let x = e.clientX || 0;
        let y = e.clientY || 0;
        if (x === 0 && y === 0) {
            const rect = btn.getBoundingClientRect();
            x = rect.left + rect.width / 2;
            y = rect.top + rect.height / 2;
        }

        showDamage(x, y, `+${gain}`, "gold");
        
        // Button visual feedback manually since :active might be tricky with preventDefault
        btn.style.transform = 'translateY(4px)';
        btn.style.boxShadow = '0 2px #cc5500';
        setTimeout(() => {
             btn.style.transform = '';
             btn.style.boxShadow = '';
        }, 50);

        checkAchievements();
        
        // Alien Event Logic: Requires 9 classes, all at least level 5
        const highLevelCount = gameState.ownedClasses.filter(c => (gameState.classLevels[c]||1) >= 5).length;
        if(gameState.ownedClasses.length >= 9 && highLevelCount >= 9 && Math.random() < 0.002 && !gameState.ownedClasses.includes("–ó–≤—ë–∑–¥–Ω—ã–π –ü–∏—Ü—Ü–∞–π–æ–ª–æ")) triggerAlienEvent();
    });
};

function updateUI() {
    document.getElementById('coins').textContent = gameState.coins;
    renderShop(); renderUpgrades(); renderItems();
    saveGame();
}

function startTutorial() { document.getElementById('tutorialModal').style.display = 'flex'; }
function unlockClass(name) { if(!gameState.ownedClasses.includes(name)) { gameState.ownedClasses.push(name); gameState.classLevels[name] = 1; updateUI(); } }
function populateAdminSelects() {
    const classSelect = document.getElementById('adminClassSelect');
    const codeSelect = document.getElementById('adminCodeClass');
    shopItems.forEach(i => {
        const opt = document.createElement('option');
        opt.value = i.name; opt.textContent = i.name;
        classSelect.appendChild(opt.cloneNode(true));
        codeSelect.appendChild(opt);
    });
}
function adminGiveClass() { unlockClass(document.getElementById('adminClassSelect').value); alert('–í—ã–¥–∞–Ω!'); }
function adminGenerateCode() {
    const name = document.getElementById('adminNewCode').value.toUpperCase().trim();
    if(!name) { alert("–ò–º—è –∫–æ–¥–∞?"); return; }
    gameState.generatedOneTimeCodes[name] = { 
        coins: parseInt(document.getElementById('adminCodeCoins').value)||0, 
        class: document.getElementById('adminCodeClass').value, used: false 
    };
    alert(`–ö–æ–¥ ${name} —Å–æ–∑–¥–∞–Ω!`); updateUI();
}
function adminGodMode() { battle.godMode = !battle.godMode; alert(`God Mode: ${battle.godMode ? "ON" : "OFF"}`); }
function adminWinBattle() { if(battle.active) { battle.enemyParty.forEach(e => { if(e.ai!=='hostage') e.hp = 0; }); checkWinCondition(); } }

function openNPC() { 
    document.getElementById('npcModal').style.display = 'flex'; 
    if(gameState.unlockedAchievements.length < 5) {
        document.getElementById('npcHelpBtn').style.display = 'inline-block';
        document.getElementById('npcHelpBtn').textContent = gameState.npcHelperActive ? "‚úÖ –ü–æ–º–æ—â—å –∞–∫—Ç–∏–≤–Ω–∞" : "üÜò –ü–æ–ø—Ä–æ—Å–∏ –ø–æ–º–æ—â–∏ –≤ –±–æ—é";
    }
    const catBtn = document.getElementById('npcCatBtn');
    catBtn.style.display = gameState.catActive ? 'none' : 'inline-block';
    
    if(gameState.ownedClasses.includes("–ø–æ–≤–µ–ª–∏—Ç–µ–ª—å –∑–≤–µ—Ä–µ–π")) document.getElementById('dinoBtn').style.display = 'inline-block';

    // Story Button
    if(gameState.completedQuests.includes('q10') && !gameState.storyFinished) {
        document.getElementById('storyBtn').style.display = 'inline-block';
        document.getElementById('npcText').textContent = "...–ù–∞–º –Ω—É–∂–Ω–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å.";
    } else {
        document.getElementById('storyBtn').style.display = 'none';
        npcTalk(); 
    }
}
function npcTalk() { document.getElementById('npcText').textContent = npcTips[Math.floor(Math.random() * npcTips.length)]; }
function npcSparring() {
    document.getElementById('npcModal').style.display = 'none';
    if(gameState.ownedClasses.length < 3) { alert("–í–∞–º –Ω—É–∂–Ω–æ 3 –±–æ–π—Ü–∞!"); return; }
    openPartySelect(false); window.isSparring = true;
}
function startDinoBattle() {
    document.getElementById('npcModal').style.display = 'none';
    if(gameState.ownedClasses.length < 3) { alert("–í–∞–º –Ω—É–∂–Ω–æ 3 –±–æ–π—Ü–∞!"); return; }
    openPartySelect(false); window.isDinoTime = true;
}
function npcEnableHelp() { gameState.npcHelperActive = !gameState.npcHelperActive; openNPC(); }
function npcAdoptCat() {
    if(gameState.coins >= 500) { gameState.coins -= 500; gameState.catActive = true; updateUI(); updateCatHouse(); openNPC(); alert("–ö–æ—Ç —É –≤–∞—Å!"); } 
    else alert("–ù—É–∂–Ω–æ 500 –º–æ–Ω–µ—Ç.");
}
function openPaths() { 
    if(!(gameState.stats.bossesDefeated||[]).includes("–ë—É—Ä–≥–µ—Ä –°–∞–º—É—Ä–∞–π")) {
        alert("–≠—Ç–æ—Ç –ø—É—Ç—å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–æ–º—É, –∫—Ç–æ –æ–¥–æ–ª–µ–ª –ë—É—Ä–≥–µ—Ä –°–∞–º—É—Ä–∞—è (–ë–æ—Å—Å 4).");
        return;
    }
    document.getElementById('npcModal').style.display = 'none'; 
    document.getElementById('pathsModal').style.display = 'flex'; 
}
function selectPath(path) { gameState.chosenPath = path; updatePathDisplay(); document.getElementById('pathsModal').style.display = 'none'; alert("–ü—É—Ç—å –≤—ã–±—Ä–∞–Ω!"); updateUI(); }
function updatePathDisplay() {
    const el = document.getElementById('activePathDisplay');
    const txt = document.getElementById('pathName');
    if(gameState.chosenPath) {
        el.style.display = 'block';
        const map = { warrior: "–í–æ–∏–Ω–∞", healer: "–¶–µ–ª–∏—Ç–µ–ª—è", wealth: "–ë–æ–≥–∞—Ç—Å—Ç–≤–∞", tank: "–¢–∞–Ω–∫–∞", ninja: "–°–∫–æ—Ä–æ—Å—Ç–∏", mage: "–ú–∞–≥–∏–∏" };
        txt.textContent = map[gameState.chosenPath];
    }
}
function feedCat() {
    if(gameState.coins >= 50) {
        gameState.coins -= 50; gameState.cats.fed = (gameState.cats.fed || 0) + 1;
        if(gameState.cats.fed >= 5) {
            gameState.cats.fed = 0; gameState.cats.count = (gameState.cats.count || 0) + 1;
            
            // Breed Logic
            const breeds = Object.keys(catBreeds);
            const breedKey = breeds[Math.floor(Math.random() * breeds.length)];
            if (!gameState.cats.list) gameState.cats.list = [];
            gameState.cats.list.push(breedKey);
            const breedName = catBreeds[breedKey].name;

            alert(`–†–æ–¥–∏–ª—Å—è –∫–æ—Ç–µ–Ω–æ–∫ –ø–æ—Ä–æ–¥—ã: ${breedName}!\n–ë–æ–Ω—É—Å: ${catBreeds[breedKey].desc}`); 
            if(gameState.cats.count >= 5) unlockAch('cat_lover');
        }
        updateUI(); updateCatHouse();
    } else alert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!");
}
function updateCatHouse() {
    if(gameState.catActive || gameState.usedCodes.includes('CATS')) {
        document.getElementById('catHouse').style.display = 'block';
        document.getElementById('catFed').textContent = gameState.cats.fed || 0;
        document.getElementById('kittenCount').textContent = gameState.cats.count || 0;
        const list = document.getElementById('kittensList'); list.innerHTML = '';
        
        (gameState.cats.list || []).forEach(breedKey => {
            const breed = catBreeds[breedKey] || {icon:'üêà', name:'–û–±—ã—á–Ω—ã–π', desc:''};
            const div = document.createElement('div'); 
            div.className = 'kitten-card';
            div.innerHTML = `<span style="font-size:1.5em">${breed.icon}</span><small>${breed.name}</small>`;
            div.title = breed.desc;
            list.appendChild(div);
        });
        
    } else document.getElementById('catHouse').style.display = 'none';
}
function checkAchievements() {
    if(gameState.coins >= 1 && !hasAch('first_coin')) unlockAch('first_coin');
    if(gameState.coins >= 1000 && !hasAch('rich')) unlockAch('rich');
    if(gameState.ownedClasses.length >= 3 && !hasAch('squad')) unlockAch('squad');
}
function hasAch(id) { return gameState.unlockedAchievements.includes(id); }
function unlockAch(id) {
    if(hasAch(id)) return;
    gameState.unlockedAchievements.push(id);
    const ach = achievements.find(a => a.id === id);
    if (ach) {
        const notif = document.createElement('div'); notif.className = 'ach-notification'; notif.textContent = `üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${ach.name}`;
        document.body.appendChild(notif); setTimeout(() => notif.remove(), 3000);
    } updateUI();
}
function openAchievements() {
    const list = document.getElementById('achList'); list.innerHTML = '';
    achievements.forEach(a => {
        const div = document.createElement('div'); div.className = 'ach-item ' + (hasAch(a.id) ? 'unlocked' : '');
        div.innerHTML = `<b>${a.name}</b><br><small>${a.desc}</small>`; list.appendChild(div);
    });
    document.getElementById('achievementsModal').style.display = 'flex';
}
function submitCode() {
    const code = document.getElementById('codeInput').value.toUpperCase().trim();
    if(gameState.generatedOneTimeCodes[code]) {
        const data = gameState.generatedOneTimeCodes[code];
        if(data.used) { alert("–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!"); return; }
        data.used = true; gameState.coins += data.coins; if(data.class) unlockClass(data.class);
        alert(`–ö–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!`); updateUI(); return;
    }
    if(secretCodes[code]) {
        if(gameState.usedCodes.includes(code) && code !== 'ADMIN' && code !== 'CATS') { alert('–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏.'); return; }
        secretCodes[code](); if(code !== 'ADMIN') gameState.usedCodes.push(code); checkAchievements(); updateUI();
    } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
}
function openAdmin() { document.getElementById('adminModal').style.display = 'flex'; }
function resetGame() { if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) { localStorage.removeItem('pizzaSaveV5'); location.reload(); } }

// QUESTS
function openQuests() {
    document.getElementById('npcModal').style.display = 'none';
    const list = document.getElementById('questListContainer'); list.innerHTML = '';
    quests.forEach(q => {
        const completed = gameState.completedQuests.includes(q.id);
        const div = document.createElement('div'); div.className = 'quest-item ' + (completed ? 'completed' : '');
        div.innerHTML = `<div><b>${q.text}</b></div><div class="quest-reward">${q.reward} üí∞</div>`;
        if(!completed) {
            const btn = document.createElement('button'); btn.className = 'nav-btn'; btn.style.background = '#27ae60'; btn.textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";
            btn.onclick = () => checkQuest(q);
            div.appendChild(btn);
        } else {
            const span = document.createElement('span'); span.textContent = "‚úÖ"; div.appendChild(span);
        }
        list.appendChild(div);
    });
    document.getElementById('questModal').style.display = 'flex';
}
function checkQuest(q) {
    if(q.check(gameState)) {
        gameState.completedQuests.push(q.id);
        gameState.coins += q.reward;
        alert(`–ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω: ${q.text}\n–ü–æ–ª—É—á–µ–Ω–æ ${q.reward} –º–æ–Ω–µ—Ç!`);
        openQuests(); updateQuestMarker(); updateUI();
    } else alert("–£—Å–ª–æ–≤–∏—è –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.");
}
function updateQuestMarker() {
    const hasNew = quests.some(q => q.check(gameState) && !gameState.completedQuests.includes(q.id));
    document.getElementById('npcQuestMark').style.display = hasNew ? 'block' : 'none';
}
function triggerEnding() {
    document.getElementById('npcModal').style.display = 'none';
    alert("–ë—ã–≤—à–∏–π –ü–∏—Ü—Ü–∞–π–æ–ª–æ —Å–Ω–∏–º–∞–µ—Ç –º–∞—Å–∫—É...");
    alert("–ü–∏—Ü—Ü–∞–π–æ–ª–æ: '–Ø –±—ã–ª –ü–∏—Ü—Ü–∞ –†–∞–±–æ–º ‚Ññ001. –Ø —Å–±–µ–∂–∞–ª –∏–∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –ë—É—Ä–≥–µ—Ä–æ–≤ –º–Ω–æ–≥–æ –ª–µ—Ç –Ω–∞–∑–∞–¥.'");
    alert("–ü–∏—Ü—Ü–∞–π–æ–ª–æ: '–¢—ã —É–Ω–∏—á—Ç–æ–∂–∏–ª –¢–µ–Ω—å –ì–Ω–µ–≤–∞ –∏ –¥–æ–∫–∞–∑–∞–ª —Å–≤–æ—é —Å–∏–ª—É. –í–æ–∑—å–º–∏ —ç—Ç–æ.'");
    alert("–ü–æ–ª—É—á–µ–Ω –ø—Ä–µ–¥–º–µ—Ç: –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –°–∫–∞–ª–∫–∞ –ü—Ä–µ–¥–∫–æ–≤!");
    gameState.inventory["–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –°–∫–∞–ª–∫–∞"] = 1;
    gameState.storyFinished = true;
    unlockAch('legend_found');
    updateUI();
}

// NINJA GAME
function startNinjaGame() {
    ninja.active = true; ninja.score = 0; ninja.elements = [];
    document.getElementById('ninjaModal').style.display = 'block'; document.getElementById('ninjaScore').textContent = 0;
    ninja.interval = setInterval(gameLoop, 20); ninja.spawnInterval = setInterval(spawnIngredient, 800);
    const cvs = document.getElementById('ninjaGameArea'); cvs.addEventListener('mousemove', handleSlice); cvs.addEventListener('touchmove', handleSlice);
}
function spawnIngredient() {
    if(!ninja.active) return;
    const type = Math.random() < 0.2 ? 'bomb' : 'food';
    const el = document.createElement('div'); el.className = 'ninja-object'; el.textContent = type === 'bomb' ? 'üí£' : ['üçÖ','üßÄ','üçÑ','üçï'].sort(()=>Math.random()-0.5)[0];
    el.style.left = Math.random() * (window.innerWidth - 50) + 'px'; el.style.top = window.innerHeight + 'px';
    document.getElementById('ninjaGameArea').appendChild(el);
    ninja.elements.push({ el, x: parseFloat(el.style.left), y: window.innerHeight, vx: (Math.random()-0.5)*10, vy: -15-Math.random()*5, type });
}
function gameLoop() {
    if(!ninja.active) return;
    for(let i = ninja.elements.length - 1; i >= 0; i--) {
        let o = ninja.elements[i]; o.x += o.vx; o.y += o.vy; o.vy += 0.5;
        o.el.style.left = o.x + 'px'; o.el.style.top = o.y + 'px';
        if(o.y > window.innerHeight + 100) { o.el.remove(); ninja.elements.splice(i, 1); }
    }
}
function handleSlice(e) {
    if(!ninja.active) return;
    const x = e.touches ? e.touches[0].clientX : e.clientX; const y = e.touches ? e.touches[0].clientY : e.clientY;
    const trail = document.createElement('div'); trail.className = 'slice-trail'; trail.style.left = x + 'px'; trail.style.top = y + 'px';
    document.getElementById('ninjaGameArea').appendChild(trail); setTimeout(() => trail.remove(), 200);
    for(let i = ninja.elements.length - 1; i >= 0; i--) {
        let o = ninja.elements[i];
        if(Math.sqrt((x-o.x-20)**2 + (y-o.y-20)**2) < 50) {
            if(o.type === 'bomb') endNinjaGame(true);
            else { ninja.score += 10; document.getElementById('ninjaScore').textContent = ninja.score; o.el.remove(); ninja.elements.splice(i, 1); }
        }
    }
}
function endNinjaGame(lost) {
    ninja.active = false; clearInterval(ninja.interval); clearInterval(ninja.spawnInterval);
    document.getElementById('ninjaGameArea').innerHTML = ''; document.getElementById('ninjaModal').style.display = 'none';
    if(lost) alert(`–ë—É–º! –û—á–∫–∏: ${ninja.score}`); else { gameState.coins += Math.floor(ninja.score/2); alert(`–ü–æ–±–µ–¥–∞! +${Math.floor(ninja.score/2)} –º–æ–Ω–µ—Ç.`); if(ninja.score>=200) unlockAch('ninja_master'); updateUI(); }
}

function renderShop() {
    const list = document.getElementById('shopList'); list.innerHTML = '';
    
    // Calculate Discount (Sphynx Cat)
    const sphynxCount = (gameState.cats.list || []).filter(c => c === 'sphynx').length;
    const discount = 1 - (sphynxCount * 0.02);

    shopItems.forEach(i => {
        if(i.isSecret || gameState.ownedClasses.includes(i.name)) return;
        const finalPrice = Math.floor(i.price * discount);
        const div = document.createElement('div'); div.className = 'item-card';
        div.innerHTML = `<h4>${i.name}</h4><small>HP: ${i.hp} | ATK: ${i.atk}</small><small>${i.special.desc}</small><button onclick="buyClass('${i.name}', ${finalPrice})" ${gameState.coins < finalPrice ? 'disabled' : ''}>${finalPrice}</button>`;
        list.appendChild(div);
    });
}
function buyClass(name, price) { if(gameState.coins >= price) { gameState.coins -= price; unlockClass(name); if(name==='–ø–∏—Ü—Ü–∞ –±–æ—Ç') unlockAch('bot_master'); if(name==='—Ç–µ—Å—Ç–æ-–≥–æ–ª–µ–º') unlockAch('unstoppable_force'); if(name==='–ø–æ–≤–µ–ª–∏—Ç–µ–ª—å –∑–≤–µ—Ä–µ–π') document.getElementById('dinoBtn').style.display='inline-block'; checkAchievements(); } }
function renderUpgrades() {
    const list = document.getElementById('upgradeList'); list.innerHTML = '';
    // Sphynx discount
    const sphynxCount = (gameState.cats.list || []).filter(c => c === 'sphynx').length;
    const discount = 1 - (sphynxCount * 0.02);

    gameState.ownedClasses.forEach(name => {
        const lvl = gameState.classLevels[name] || 1; 
        const cost = Math.floor(Math.floor(100 * Math.pow(1.5, lvl)) * discount);
        const div = document.createElement('div'); div.className = 'item-card';
        div.innerHTML = `<h4>${name} (Lv.${lvl})</h4><button onclick="upgradeClass('${name}', ${cost})" ${gameState.coins < cost ? 'disabled' : ''}>UP (${cost})</button>`;
        list.appendChild(div);
    });
}
function upgradeClass(name, cost) { if(gameState.coins >= cost) { gameState.coins -= cost; gameState.classLevels[name]++; updateUI(); } }
function renderItems() {
    const list = document.getElementById('itemShopList'); list.innerHTML = '';
    const sphynxCount = (gameState.cats.list || []).filter(c => c === 'sphynx').length;
    const discount = 1 - (sphynxCount * 0.02);

    items.forEach(i => {
        if(i.isSecret) return;
        const finalPrice = Math.floor(i.price * discount);
        const div = document.createElement('div'); div.className = 'item-card';
        div.innerHTML = `<h4>${i.name}</h4><small>x${gameState.inventory[i.name]||0}</small><button onclick="buyItem('${i.name}', ${finalPrice})" ${gameState.coins < finalPrice ? 'disabled' : ''}>${finalPrice}</button>`;
        list.appendChild(div);
    });
}
function buyItem(name, price) { if(gameState.coins >= price) { gameState.coins -= price; gameState.inventory[name] = (gameState.inventory[name]||0)+1; if(Object.keys(gameState.inventory).length>=3) unlockAch('pizza_collector'); updateUI(); } }
function startAutoClickers() {
    for(let k in gameState.autoClickers) clearInterval(gameState.autoClickers[k]);
    
    // Persian Cat Buff (Speed)
    const persianCount = (gameState.cats.list || []).filter(c => c === 'persian').length;
    const speedMult = Math.max(0.1, 1 - (persianCount * 0.1)); // 10% faster per cat, max cap implicit

    // Legend Item Buff
    const legendMult = (gameState.inventory["–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –°–∫–∞–ª–∫–∞"]||0) > 0 ? 1.5 : 1;

    gameState.ownedClasses.forEach(name => {
        const d = shopItems.find(i => i.name === name);
        if(d && d.autoClick) {
            gameState.autoClickers[name] = setInterval(() => { 
                gameState.coins += Math.floor(d.autoClick.amount * legendMult); 
                document.getElementById('coins').textContent = gameState.coins; 
            }, d.autoClick.interval * speedMult);
        }
    });
}
function triggerAlienEvent() { alienEvent.active = true; alienEvent.macaroni = 0; document.getElementById('macaroniCount').textContent = 0; document.getElementById('alienModal').style.display = 'flex'; }
function clickMacaroni() { alienEvent.macaroni += 10; document.getElementById('macaroniCount').textContent = alienEvent.macaroni; if(alienEvent.macaroni >= 2000) { alert("–í—ã —Å–±–µ–∂–∞–ª–∏! +–ó–≤—ë–∑–¥–Ω—ã–π –ü–∏—Ü—Ü–∞–π–æ–ª–æ"); unlockClass("–ó–≤—ë–∑–¥–Ω—ã–π –ü–∏—Ü—Ü–∞–π–æ–ª–æ"); unlockAch('abduction_survivor'); document.getElementById('alienModal').style.display = 'none'; alienEvent.active = false; } }

// BATTLE
let selectedParty = [];
function openPartySelect(isBossRush) {
    if(gameState.ownedClasses.length === 0) { alert("–ù—É–∂–Ω—ã –∫–ª–∞—Å—Å—ã!"); return; }
    if(!isBossRush && gameState.ownedClasses.length < 3) { alert("–ù—É–∂–Ω–æ 3 –∫–ª–∞—Å—Å–∞!"); return; }
    document.getElementById('npcModal').style.display = 'none';
    document.getElementById('partySelectTitle').textContent = isBossRush ? "–í—ã–±–µ—Ä–∏—Ç–µ –ì–ï–†–û–Ø" : "–í—ã–±–µ—Ä–∏—Ç–µ 3 –±–æ–π—Ü–æ–≤";
    document.getElementById('confirmBattleBtn').onclick = () => confirmBattle(isBossRush);
    selectedParty = []; renderPartyGrid(isBossRush ? 1 : 3); 
    document.getElementById('partySelectModal').style.display = 'flex';
}
function renderPartyGrid(max) {
    const grid = document.getElementById('partyGrid'); grid.innerHTML = '';
    gameState.ownedClasses.forEach(name => {
        const div = document.createElement('div'); div.className = 'select-item ' + (selectedParty.includes(name) ? 'selected' : '');
        div.textContent = `${name} (Lv.${gameState.classLevels[name]})`;
        div.onclick = () => { if(selectedParty.includes(name)) selectedParty = selectedParty.filter(n=>n!==name); else if(selectedParty.length < max) selectedParty.push(name); renderPartyGrid(max); };
        grid.appendChild(div);
    });
}
function startBossRushSetup() { openPartySelect(true); }
function confirmBattle(isBossRush) {
    if(selectedParty.length !== (isBossRush ? 1 : 3)) { alert("–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª-–≤–æ!"); return; }
    document.getElementById('partySelectModal').style.display = 'none';
    if(isBossRush) initBossRush(); else initBattle();
}
function initBossRush() {
    battle.isBossRush = true;
    let list = enemies.filter(e => e.ai !== 'dummy' && e.name !== "–ü–∏—Ü—Ü–∞ –†–∞–± (–í—Ä–∞–≥)" && e.ai !== 'camo' && e.name !== "–ú–µ–ª–∫–∏–π –ê–Ω–æ–º–∞–ª–æ—Ä–æ–Ω–∏" && e.ai !== 'pizzasaur').map(e => ({...e}));
    if(gameState.ownedClasses.includes("–ø–∏—Ü—Ü–∞ –∫—Ä–∞—Ç–æ—Å")) list.push({...specialEnemies.god});
    battle.bossRushQueue = list; initBattle(true);
}
function initBattle(skipGen) {
    battle.enemyParty = [];
    battle.pizzasaurFed = 0; // Reset feeding
    
    // CALCULATE LEVEL SCORE
    const partyLevels = selectedParty.map(name => gameState.classLevels[name] || 1);
    const totalLevels = partyLevels.reduce((a,b)=>a+b, 0);
    const levelScore = Math.max(1, Math.floor(totalLevels / 2));

    const scale = (t) => {
        let e = JSON.parse(JSON.stringify(t));
        // Add minimal stats based on level diff
        const levelDiff = Math.max(0, levelScore - (t.minLevel || 0));
        e.hp += levelDiff * 20; e.maxHp = e.hp; e.atk += levelDiff * 2;
        e.isDead = false; e.isRaged = false;
        
        // Camo Reset
        if(e.ai === 'camo') {
            e.realName = e.name;
            e.realSprite = e.sprite;
            e.name = "–ë—É—Ä–≥–µ—Ä-–ì–∞–Ω–≥—Å—Ç–µ—Ä";
            e.sprite = "üçî";
            e.revealed = false;
        }

        return e;
    };

    if(battle.isBossRush) {
        let next = battle.bossRushQueue.shift();
        if(!next) { endBattle(true); return; }
        battle.enemyParty.push(scale(next));
    } else if (window.isSparring) {
        battle.enemyParty.push(scale(enemies.find(e => e.ai === 'dummy'))); window.isSparring = false;
    } else if (window.isDinoTime) {
        // Dino Battle
        const dino = enemies.find(e => e.ai === 'pizzasaur');
        battle.enemyParty.push(scale(dino)); window.isDinoTime = false;
    } else {
        // Filter enemies based on level score
        let avail = enemies.filter(e => e.ai !== 'dummy' && e.name !== "–¢–µ–Ω—å –ì–Ω–µ–≤–∞ (–ë–æ—Å—Å)" && e.name !== "–ë—É—Ä–≥–µ—Ä –ë–æ–≥" && (e.minLevel || 0) <= levelScore && e.name !== "–ú–µ–ª–∫–∏–π –ê–Ω–æ–º–∞–ª–æ—Ä–æ–Ω–∏" && e.ai !== "pizzasaur");
        if(avail.length === 0) avail = [enemies[0]];

        if(gameState.ownedClasses.includes("–ø–∏—Ü—Ü–∞ –∫—Ä–∞—Ç–æ—Å")) avail.push(specialEnemies.god);

        let main = avail[Math.floor(Math.random() * avail.length)];
        
        // BOSS WARNING
        if(main.ai === 'boss' || main.ai === 'boss_swoon' || main.ai === 'bus' || main.ai === 'matriarch' || main.ai === 'camo') {
            alert(`‚ö†Ô∏è –ü–ò–¶–¶–ê–ô–û–õ–û –î–†–û–ñ–ò–¢... –≠–¢–û –ë–û–°–°: ${main.name}!`);
        }

        battle.enemyParty.push(scale(main));
        
        const isBoss = (main.ai === 'boss' || main.ai === 'boss_swoon' || main.ai === 'matriarch');
        if((Math.random() < 0.3 || main.name.includes("–ë—É—Ä–≥–µ—Ä")) && !battle.isBossRush) {
            let minion = enemies.find(e => e.name === "–ö–∞—Ä—Ç–æ—à–∫–∞-–§—Ä–∏");
            battle.enemyParty.push(scale(minion));
            // Slave encounter logic
            if(main.name.includes("–ë—É—Ä–≥–µ—Ä") && !gameState.ownedClasses.includes("–ü–∏—Ü—Ü–∞ –†–∞–±") && Math.random() < 0.5) {
                battle.enemyParty.push(scale(specialEnemies.slave));
            }
        }
    }

    // Maine Coon Buff
    const coonCount = (gameState.cats.list || []).filter(c => c === 'mainecoon').length;
    let atkMult = 1 + (coonCount * 0.05);

    // Legend Item Buff
    if((gameState.inventory["–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –°–∫–∞–ª–∫–∞"]||0) > 0) atkMult += 0.2;

    battle.party = selectedParty.map((name, i) => {
        const t = shopItems.find(x => x.name === name);
        const lvl = gameState.classLevels[name] || 1;
        let m = 1 + (lvl * 0.1);
        let hm = 1, am = 1;
        if(gameState.chosenPath === 'warrior') am += 0.2; if(gameState.chosenPath === 'healer') hm += 0.2;
        if(gameState.chosenPath === 'tank') hm += 0.5;
        
        // Apply Cat & Item Buff
        am += (atkMult - 1);

        return { id: i, name, maxHp: Math.floor(t.hp*m*hm), hp: Math.floor(t.hp*m*hm), atk: Math.floor(t.atk*m*am), special: t.special, def: 0, isDead: false, isMounted: false };
    });

    battle.active = true; battle.turn = 0; battle.tp = 0; battle.activeCharIdx = 0;
    battle.rageMode = false; battle.swoonTriggered = false; battle.targetIdx = 0;
    if(battle.isBossRush) { battle.rageMode = true; battle.party[0].hp = battle.party[0].maxHp; }

    document.getElementById('battleModal').style.display = 'flex';
    logBattle("–ë–û–ô –ù–ê–ß–ê–õ–°–Ø!", "yellow");
    updateBattleUI(); findNextActiveChar();
}

function updateBattleUI() {
    const es = document.getElementById('enemySlots'); es.innerHTML = '';
    battle.enemyParty.forEach((en, i) => {
        if(en.isDead) return;
        const d = document.createElement('div');
        let classes = 'enemy-card ' + (i === battle.targetIdx ? 'selected-target ' : '') + (en.isRaged ? 'rage ' : '');
        if(en.ai === 'hostage') classes += 'hostage ';
        if(en.name === '–ó–æ–ª–æ—Ç–∞—è –ö—Ä—ã—Å–∞') classes += 'golden ';
        d.className = classes;
        d.onclick = () => { battle.targetIdx = i; updateBattleUI(); };
        d.innerHTML = `<div class="enemy-sprite">${en.sprite}</div><div style="font-size:0.8em">${en.name}</div><div class="hp-bar-bg" style="width:80px"><div class="hp-fill" style="background:var(--enemy-hp-color);width:${(en.hp/en.maxHp)*100}%"></div></div><div>${Math.max(0,en.hp)}</div>`;
        es.appendChild(d);
    });

    const ps = document.getElementById('partySlots'); ps.innerHTML = '';
    battle.party.forEach((p, i) => {
        let cls = 'char-card'; if(i === battle.activeCharIdx && battle.turn===0 && !p.isDead) cls += ' active';
        if(p.isDead) cls += ' dead'; if(battle.rageMode && !p.isDead) cls += ' rage';
        if(p.isMounted) cls += ' mounted';
        const d = document.createElement('div'); d.className = cls;
        let icon = ""; if(p.isMounted) icon = "ü¶ñ ";
        d.innerHTML = `<div>${icon}<b>${p.name}</b> ${p.hp}/${p.maxHp}</div><div class="hp-bar-bg"><div class="hp-fill" style="width:${(p.hp/p.maxHp)*100}%"></div></div>`;
        ps.appendChild(d);
    });

    document.getElementById('tpBar').style.width = battle.tp + '%'; document.getElementById('tpText').textContent = battle.tp;
    document.getElementById('turnIndicator').textContent = battle.turn===0 ? "–í–ê–® –•–û–î" : "–í–†–ê–ì";
    document.getElementById('turnIndicator').style.color = battle.turn===0 ? "var(--primary-color)" : "red";
    
    const char = battle.party[battle.activeCharIdx]; const can = battle.turn===0 && char && !char.isDead;
    ['btnAtk','btnDef','btnItm','btnSkl'].forEach(id=>document.getElementById(id).disabled=!can);
    const skl = document.getElementById('btnSkl');
    if(can) {
        if(battle.rageMode) { skl.textContent = "–í–û–ó–ú–ï–ó–î–ò–ï"; skl.style.background = "var(--rage-color)"; }
        else { skl.textContent = `${char.special.name} (${char.special.cost})`; skl.style.background = "#9b59b6"; skl.disabled = battle.tp < char.special.cost; }
    }

    // Mount Button Visibility
    const mnt = document.getElementById('btnMount');
    if(can && (gameState.inventory["–ü–æ–≤–æ–¥—å—è –ü–∏—Ü—Ü–∞–∑–∞–≤—Ä–∞"]||0) > 0 && !char.isMounted) {
        mnt.style.display = "block";
    } else {
        mnt.style.display = "none";
    }
}

function logBattle(msg, c="#ccc") { const l = document.getElementById('battleLog'); l.innerHTML += `<div style="color:${c}">${msg}</div>`; l.scrollTop = l.scrollHeight; }
function showDamage(x, y, t, c="white") { const e = document.createElement('div'); e.className = 'damage-popup'; e.textContent = t; e.style.color = c; e.style.left = x+'px'; e.style.top = y+'px'; document.body.appendChild(e); setTimeout(()=>e.remove(), 1000); }

function findNextActiveChar() {
    if(battle.party.every(p => p.isDead)) { endBattle(false); return; }
    // Auto target
    if(battle.enemyParty[battle.targetIdx]?.isDead) {
        const ni = battle.enemyParty.findIndex(e=>!e.isDead);
        if(ni !== -1) battle.targetIdx = ni; else {
            // All enemies dead? Check win condition first
            checkWinCondition();
            return;
        }
    }
    updateBattleUI();
}

function playerAction(type) {
    const c = battle.party[battle.activeCharIdx];
    let t = battle.enemyParty[battle.targetIdx];
    if(!t || t.isDead) return;

    if(type === 'attack') {
        let d = c.atk; if(battle.rageMode) d *= 3;
        // Camo Reveal Logic
        if(t.ai === 'camo' && !t.revealed) {
            t.revealed = true; t.name = t.realName; t.sprite = t.realSprite;
            logBattle("–ö–ê–ú–£–§–õ–Ø–ñ –†–ê–°–ö–†–´–¢!", "orange");
            showDamage(window.innerWidth/2, window.innerHeight/2, "–†–ê–ó–û–ë–õ–ê–ß–ï–ù–ò–ï!", "red");
        }
        
        // Pizzasaur warning
        if(t.ai === 'pizzasaur') {
             if(Math.random() < 0.2) logBattle("–ü–∏—Ü—Ü–∞–∑–∞–≤—Ä —Ä—ã—á–∏—Ç!", "orange");
        }

        t.hp -= d; battle.tp = Math.min(100, battle.tp+10); logBattle(`${c.name} –∞—Ç–∞–∫–æ–≤–∞–ª (-${d})`);
    } else if (type === 'defend') {
        c.def = gameState.chosenPath==='tank'?0.8:0.5; battle.tp = Math.min(100, battle.tp+15); logBattle("–ó–∞—â–∏—Ç–∞");
    } else if (type === 'special') {
        if(battle.rageMode) { t.hp -= c.atk*10; logBattle("–í–û–ó–ú–ï–ó–î–ò–ï!", "orange"); }
        else {
            battle.tp -= c.special.cost;
            
            // Beastmaster Tame
            if(c.special.name === "–£–∫—Ä–æ—â–µ–Ω–∏–µ" && t.ai === "pizzasaur") {
                 let chance = 0.1 + (battle.pizzasaurFed * 0.2); // +20% per pizza
                 if(Math.random() < chance) {
                     alert("–í–´ –ü–†–ò–†–£–ß–ò–õ–ò –ü–ò–¶–¶–ê–ó–ê–í–†–ê! –û–ù –í–ê–®!");
                     gameState.inventory["–ü–æ–≤–æ–¥—å—è –ü–∏—Ü—Ü–∞–∑–∞–≤—Ä–∞"] = 1;
                     unlockAch("dino_tamer");
                     endBattle(true); return;
                 } else {
                     logBattle("–£–∫—Ä–æ—â–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å...", "red");
                     t.hp -= 20; // Small damage
                 }
            }
            // Simplified special logic for brevity
            else if(c.special.name.includes("–£–±–æ—Ä–∫–∞")) { t.hp = 0; logBattle("–£–±–æ—Ä–∫–∞!", "cyan"); }
            else if(c.special.name.includes("—Ö–∏–ª–ª")) { c.hp = c.maxHp; logBattle("–õ–µ—á–µ–Ω–∏–µ", "green"); }
            else { t.hp -= c.atk*2; logBattle("–ù–∞–≤—ã–∫!"); }
        }
    } else if (type === 'item') {
        if(gameState.inventory["–ö—É—Å–æ—á–µ–∫ –ø–∏—Ü—Ü—ã"]>0) { 
            gameState.inventory["–ö—É—Å–æ—á–µ–∫ –ø–∏—Ü—Ü—ã"]--; 
            
            // Feeding Pizzasaur
            if(t.ai === 'pizzasaur') {
                battle.pizzasaurFed++;
                logBattle("–ü–∏—Ü—Ü–∞–∑–∞–≤—Ä —Å—ä–µ–ª –ø–∏—Ü—Ü—É! (–î–æ–≤–µ—Ä–∏–µ —Ä–∞—Å—Ç–µ—Ç)", "green");
                t.atk = Math.max(10, t.atk - 10); // Becomes less aggressive
            } else {
                c.hp=Math.min(c.maxHp, c.hp+50); logBattle("–ü–∏—Ü—Ü–∞ (+50HP)"); 
            }
            updateUI(); 
        }
        else { logBattle("–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤", "red"); return; }
    } else if (type === 'mount') {
        // Mount mechanic
        c.isMounted = true;
        c.maxHp += 500; c.hp += 500; c.atk += 50;
        logBattle(`${c.name} –û–°–ï–î–õ–ê–õ –ü–ò–¶–¶–ê–ó–ê–í–†–ê!`, "gold");
        battle.tp = Math.max(0, battle.tp - 50); // Cost 50 TP maybe? Or free since item
        // One time use per char, button hides
    }

    if(t.hp <= 0) { t.hp = 0; t.isDead = true; logBattle(`${t.name} –ø–æ–≤–µ—Ä–∂–µ–Ω!`, "green"); }
    
    // Check win condition instantly after action
    if(checkWinCondition()) return;
    
    if(battle.active) advanceTurn();
}

function advanceTurn() {
    battle.activeCharIdx++;
    while(battle.activeCharIdx < battle.party.length && battle.party[battle.activeCharIdx].isDead) battle.activeCharIdx++;
    if(battle.activeCharIdx >= battle.party.length) { battle.turn = 1; battle.activeCharIdx = -1; updateBattleUI(); setTimeout(enemyAI, 1000); }
    else updateBattleUI();
}

function enemyAI() {
    if(!battle.active) return;
    
    // NPC Helper
    if(gameState.npcHelperActive && Math.random() < 0.5) {
        const t = battle.enemyParty.find(e=>!e.isDead); if(t) { t.hp -= 20; logBattle("–ü–æ–º–æ—â—å –ù–ü–° (-20)", "cyan"); }
    }

    // CHECK ENEMY RAGE (Last Stand)
    const aliveEnemies = battle.enemyParty.filter(e => !e.isDead);
    if(battle.enemyParty.length > 1 && aliveEnemies.length === 1 && !aliveEnemies[0].isRaged && aliveEnemies[0].ai !== 'hostage') {
        const survivor = aliveEnemies[0];
        survivor.isRaged = true;
        survivor.atk = Math.floor(survivor.atk * 1.5);
        logBattle(`üî• ${survivor.name} –í –Ø–†–û–°–¢–ò! (–û—Å—Ç–∞–ª—Å—è –æ–¥–∏–Ω)`, "red");
        document.getElementById('battleContainer').classList.add('swoon-effect');
        setTimeout(()=>document.getElementById('battleContainer').classList.remove('swoon-effect'), 500);
    }

    aliveEnemies.forEach(en => {
        // Hostage Logic
        if(en.ai === 'hostage') {
            logBattle(`${en.name} –¥—Ä–æ–∂–∏—Ç –æ—Ç —Å—Ç—Ä–∞—Ö–∞...`);
            return;
        }

        // Pizzasaur Logic
        if(en.ai === 'pizzasaur') {
             if(Math.random() < 0.3) {
                 logBattle("–ü–∏—Ü—Ü–∞–∑–∞–≤—Ä –∏—â–µ—Ç –µ–¥—É...", "yellow");
                 return; // Skipped turn looking for food
             }
        }

        // Flee Logic (Golden Rat)
        if(en.ai === 'flee') {
            logBattle(`${en.name} –ø—ã—Ç–∞–µ—Ç—Å—è —Å–±–µ–∂–∞—Ç—å!`, "gold");
            if(Math.random() < 0.3) {
                en.hp = 0; en.isDead = true; en.reward = 0; // Fled
                logBattle(`${en.name} —Å–±–µ–∂–∞–ª–∞ —Å –¥–µ–Ω—å–≥–∞–º–∏!`, "red");
            }
            return;
        }

        // Traitor Logic
        if(en.ai === 'traitor' && Math.random() < 0.4) {
             const t = battle.party.filter(p=>!p.isDead)[0];
             if(t) {
                let dmg = Math.floor(en.atk * 1.5);
                t.hp -= dmg;
                battle.tp = Math.max(0, battle.tp - 20);
                logBattle(`${en.name} –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ü–†–ï–î–ê–¢–ï–õ–¨–°–¢–í–û!`, "purple");
                if(t.hp<=0) { t.hp=0; t.isDead=true; }
             }
             return;
        }

        // Regen Logic (Ancient Dough)
        if(en.ai === 'regen') {
            const heal = Math.floor(en.maxHp * 0.1);
            en.hp = Math.min(en.maxHp, en.hp + heal);
            logBattle(`${en.name} –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º—É (+${heal})`, "green");
        }

        // Tank Logic (Mecha Oven)
        if(en.ai === 'tank' && Math.random() < 0.3) {
            logBattle(`${en.name} –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –©–ò–¢!`, "blue");
            // Simplified: skips attack to defend (next hit logic handled by player dmg calc usually, but here just flavor + skip atk)
            return;
        }

        // BUS LOGIC
        if(en.ai === 'bus' && en.hp < en.maxHp * 0.5 && Math.random() < 0.33) {
             const targets = battle.party.filter(p=>!p.isDead);
             if(targets.length > 0) {
                 const t = targets[Math.floor(Math.random()*targets.length)];
                 logBattle(`üöå –ê–í–¢–û–ë–£–° –ü–ï–†–ï–ï–•–ê–õ ${t.name}!`, "red");
                 showDamage(window.innerWidth/2, window.innerHeight/2, "CRITICAL HIT!", "red");
                 t.hp = 0; t.isDead = true;
                 return; // Bus used special, end its turn
             }
        }

        // MATRIARCH LOGIC
        if(en.ai === 'matriarch') {
            // Spawn Minions
            if(battle.enemyParty.length < 5 && Math.random() < 0.3) {
                 const minionTemplate = enemies.find(e=>e.name==="–ú–µ–ª–∫–∏–π –ê–Ω–æ–º–∞–ª–æ—Ä–æ–Ω–∏");
                 if(minionTemplate) {
                     const minion = JSON.parse(JSON.stringify(minionTemplate));
                     minion.hp = 100; minion.maxHp = 100; minion.isDead = false;
                     battle.enemyParty.push(minion);
                     logBattle("ü¶ê –ú–∞—Ç–∫–∞ –ø—Ä–∏–∑–≤–∞–ª–∞ –ê–Ω–æ–º–∞–ª–æ—Ä–æ–Ω–∏!", "green");
                     updateBattleUI();
                 }
            }
        }

        // BOSS SWOON LOGIC (Player Rage)
        if((en.ai === 'boss_swoon' || en.ai === 'matriarch') && !battle.swoonTriggered && en.hp < en.maxHp*0.4 && !battle.isBossRush) {
            battle.swoonTriggered = true; logBattle(`‚ö†Ô∏è ${en.name} –ò–°–ü–û–õ–¨–ó–£–ï–¢ SWOON!`, "red");
            const survivors = battle.party.filter(p=>!p.isDead);
            if(survivors.length > 1) {
                const lucky = survivors[Math.floor(Math.random()*survivors.length)];
                battle.party.forEach(p => { if(p !== lucky) { p.hp = 0; p.isDead = true; } });
                lucky.maxHp *= 2; lucky.hp = lucky.maxHp; lucky.atk *= 2; battle.rageMode = true;
                logBattle(`üî• ${lucky.name} –í –ì–ù–ï–í–ï!`, "orange");
                unlockAch('rage_mode');
            }
        } else {
            const t = battle.party.filter(p=>!p.isDead)[Math.floor(Math.random()*battle.party.filter(p=>!p.isDead).length)];
            if(t) {
                let dmg = en.atk;
                if(battle.godMode) dmg = 0;
                if(t.def > 0) { dmg = Math.floor(dmg*t.def); t.def = 0; }
                t.hp -= dmg; if(t.hp<=0) { t.hp=0; t.isDead=true; }
                logBattle(`${en.name} –±—å–µ—Ç ${t.name} (-${dmg})`);
            }
        }
    });

    if(battle.party.every(p=>p.isDead)) endBattle(false);
    else { battle.turn = 0; battle.activeCharIdx = 0; while(battle.party[battle.activeCharIdx].isDead) battle.activeCharIdx++; updateBattleUI(); }
}

function checkWinCondition() {
    const aliveEnemies = battle.enemyParty.filter(e => !e.isDead);
    const threats = aliveEnemies.filter(e => e.ai !== 'hostage');
    
    // Win if all threats are gone
    if(threats.length === 0) {
        if(battle.isBossRush && battle.bossRushQueue.length > 0) { logBattle("–°–ª–µ–¥. –≤—Ä–∞–≥...", "yellow"); setTimeout(()=>initBattle(true),1000); return true; }
        else {
            endBattle(true, aliveEnemies.some(e => e.ai === 'hostage'));
            return true;
        }
    }
    return false;
}

function endBattle(win, savedHostage) {
    battle.active = false;
    if(win) {
        let r = battle.enemyParty.reduce((a,b)=>a+(b.reward||0),0);
        if(battle.isBossRush) { r = 10000; unlockAch('boss_rush_complete'); }
        gameState.coins += r; 
        gameState.stats.battlesWon = (gameState.stats.battlesWon||0) + 1;
        
        // Track bosses
        battle.enemyParty.forEach(e => {
            if(e.ai==='boss' || e.ai==='boss_swoon' || e.ai==='bus' || e.ai==='matriarch' || e.ai==='camo') {
                if(!gameState.stats.bossesDefeated) gameState.stats.bossesDefeated = [];
                if(!gameState.stats.bossesDefeated.includes(e.name)) gameState.stats.bossesDefeated.push(e.name);
            }
        });

        // Slave Rescue
        if(savedHostage && !gameState.ownedClasses.includes("–ü–∏—Ü—Ü–∞ –†–∞–±")) {
            alert("–í—ã —Å–ø–∞—Å–ª–∏ –ü–∏—Ü—Ü–∞ –†–∞–±–∞! –û–Ω –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –≤–∞–º."); unlockClass("–ü–∏—Ü—Ü–∞ –†–∞–±"); unlockAch('slave_freed');
        }

        updateUI(); updateQuestMarker(); unlockAch('win_battle');
        checkAchievements();
        if(!battle.isBossRush) alert(`–ü–æ–±–µ–¥–∞! +${r} –º–æ–Ω–µ—Ç.`);
    } else alert("–ü–æ—Ä–∞–∂–µ–Ω–∏–µ...");
    battle.isBossRush = false; battle.bossRushQueue = [];
    document.getElementById('battleModal').style.display = 'none';
}
function exitBattle() { if(confirm("–°–±–µ–∂–∞—Ç—å?")) endBattle(false); }
function saveGame() { try { localStorage.setItem('pizzaSaveV5', JSON.stringify(gameState)); } catch(e){} }
function loadGame() {
    try {
        const d = JSON.parse(localStorage.getItem('pizzaSaveV5'));
        if(d) {
            gameState.coins = d.coins||0; gameState.ownedClasses = d.ownedClasses||[];
            gameState.classLevels = d.classLevels||{}; gameState.inventory = d.inventory||{};
            gameState.unlockedAchievements = d.unlockedAchievements||[]; gameState.usedCodes = d.usedCodes||[];
            gameState.npcHelperActive = d.npcHelperActive||false; gameState.catActive = d.catActive||false;
            gameState.chosenPath = d.chosenPath||null; 
            gameState.stats = d.stats || { battlesWon: 0, bossesDefeated: [] };
            gameState.completedQuests = d.completedQuests || [];
            gameState.storyFinished = d.storyFinished || false;
            
            if(d.cats) { 
                gameState.cats.count = d.cats.count||0; 
                gameState.cats.fed = d.cats.fed||0; 
                gameState.cats.list = d.cats.list||[];
            }
        }
    } catch(e) {}
}
async function handleModLoad(e) {
    const f = e.target.files[0]; if(!f) return;
    try {
        const z = await new JSZip().loadAsync(f);
        if(z.file("data/main.json")) {
            const d = JSON.parse(await z.file("data/main.json").async("string"));
            if(d.classes) d.classes.forEach(c=>shopItems.push({name:c.name,price:c.price,hp:50,atk:5,special:{name:"Mod",cost:10,desc:"-"}}));
            alert("–ú–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω!"); renderShop();
        }
    } catch(x) { alert("–û—à–∏–±–∫–∞ –º–æ–¥–∞"); }
}
document.getElementById('modFileInput').addEventListener('change', handleModLoad);
</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
